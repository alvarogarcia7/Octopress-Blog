<div class="highlight"><pre><span class="c"># listen on 127.0.0.1:5222</span>
<span class="n">PROXY_HOST</span> <span class="o">=</span> <span class="err">“</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="err">”</span>
<span class="n">PROXY_PORT</span> <span class="o">=</span> <span class="mi">5222</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;send-everything-to-hipchatservercom5222&quot;</span><span class="o">&gt;</span><span class="n">send</span> <span class="n">everything</span> <span class="n">to</span> <span class="n">hipchatserver</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">5222</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">REMOTE_HOST</span> <span class="o">=</span> <span class="err">“</span><span class="mf">10.11</span><span class="o">.</span><span class="mf">1.25</span><span class="err">”</span>  <span class="c"># hipchatserver.com</span>
<span class="n">REMOTE_PORT</span> <span class="o">=</span> <span class="mi">5222</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;buffer-size-in-bytes&quot;</span><span class="o">&gt;</span><span class="nb">buffer</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">bytes</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># we will need such a large buffer because server will send a lot of data after the connection is established</span>
<span class="n">BUF_SIZE</span> <span class="o">=</span> <span class="mi">8192</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span><span class="p">,</span> <span class="n">unhexlify</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;create-socket-1270015222&quot;</span><span class="o">&gt;</span><span class="n">create</span> <span class="n">socket</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5222</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;this-cant-be-non-blocking-for-obvious-reasons&quot;</span><span class="o">&gt;</span><span class="n">this</span> <span class="n">can</span><span class="err">’</span><span class="n">t</span> <span class="n">be</span> <span class="n">non</span><span class="o">-</span><span class="n">blocking</span> <span class="k">for</span> <span class="n">obvious</span> <span class="n">reasons</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">listensocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;bind-it-to-1270015222&quot;</span><span class="o">&gt;</span><span class="n">bind</span> <span class="n">it</span> <span class="n">to</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5222</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">listensocket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">PROXY_HOST</span><span class="p">,</span> <span class="n">PROXY_PORT</span><span class="p">))</span>
<span class="n">listensocket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># 1 for now - you can add more if you want multiple clients but we only need one&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Created</span> <span class="n">socket</span> <span class="n">on</span> <span class="o">%</span><span class="n">s</span><span class="p">:</span><span class="o">%</span><span class="n">s</span> <span class="ow">and</span> <span class="n">listening</span><span class="err">”</span> <span class="o">%</span> <span class="p">(</span><span class="n">PROXY_HOST</span><span class="p">,</span> <span class="n">PROXY_PORT</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;now-accept-connections-from-hipchat-client&quot;</span><span class="o">&gt;</span><span class="n">now</span> <span class="n">accept</span> <span class="n">connections</span> <span class="kn">from</span> <span class="nn">hipchat</span> <span class="nn">client</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">clientsocket</span><span class="p">,</span> <span class="n">clientaddress</span> <span class="o">=</span> <span class="n">listensocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;this-should-be-localhost-or-127001&quot;</span><span class="o">&gt;</span><span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="n">localhost</span> <span class="ow">or</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># str is needed because otherwise it cannot be printed properly and we get an errors</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Accepted</span> <span class="n">connection</span> <span class="kn">from</span> <span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">clientaddress</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;listen-for-xmppmsg1-first-step-of-xmpp--handshake&quot;</span><span class="o">&gt;</span><span class="n">listen</span> <span class="k">for</span> <span class="n">xmpp_msg1</span> <span class="p">(</span><span class="n">first</span> <span class="n">step</span> <span class="n">of</span> <span class="n">XMPP</span>  <span class="n">handshake</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">xmpp_msg1</span> <span class="o">=</span> <span class="n">clientsocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="n">msg</span> <span class="kn">from</span> <span class="nn">client</span><span class="p">:</span>\<span class="n">n</span><span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmpp_msg1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;create-a-connection-to-srver-and-send-it&quot;</span><span class="o">&gt;</span><span class="n">create</span> <span class="n">a</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">srver</span> <span class="ow">and</span> <span class="n">send</span> <span class="n">it</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">serversocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span> <span class="p">(</span><span class="n">REMOTE_HOST</span><span class="p">,</span> <span class="n">REMOTE_PORT</span><span class="p">)</span> <span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="o">%</span><span class="n">s</span><span class="p">:</span><span class="o">%</span><span class="n">s</span>\<span class="n">n</span><span class="err">”</span> <span class="o">%</span> <span class="p">(</span><span class="n">REMOTE_HOST</span><span class="p">,</span> <span class="n">REMOTE_PORT</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;send-xmppmsg1&quot;</span><span class="o">&gt;</span><span class="n">send</span> <span class="n">xmpp_msg1</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">serversocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg1</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">xmpp_msg1</span> <span class="n">to</span> <span class="n">server</span><span class="err">”</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;receive-xmppmsg2-from-server&quot;</span><span class="o">&gt;</span><span class="n">receive</span> <span class="n">xmpp_msg2</span> <span class="kn">from</span> <span class="nn">server</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">xmpp_msg2</span> <span class="o">=</span> <span class="n">serversocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="n">msg</span> <span class="kn">from</span> <span class="nn">server</span><span class="p">:</span>\<span class="n">n</span><span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span><span class="p">(</span><span class="n">xmpp_msg2</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;relay-it-to-client&quot;</span><span class="o">&gt;</span><span class="n">relay</span> <span class="n">it</span> <span class="n">to</span> <span class="n">client</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">clientsocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg2</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Send</span> <span class="n">xmpp_msg2</span> <span class="n">to</span> <span class="n">client</span><span class="err">”</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;receive-xmppmsg3&quot;</span><span class="o">&gt;</span><span class="n">receive</span> <span class="n">xmpp_msg3</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">xmpp_msg3</span> <span class="o">=</span> <span class="n">clientsocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="n">xmpp_msg3</span> <span class="p">(</span><span class="n">STARTTLS</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">client</span><span class="p">:</span>\<span class="n">n</span><span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmpp_msg3</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;this-should-be-the-starttls-one&quot;</span><span class="o">&gt;</span><span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="n">the</span> <span class="n">STARTTLS</span> <span class="n">one</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># &lt;starttls xmlns=&quot;urn:ietf:params:xml:ns:xmpp-tls&quot; /&gt;&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;relay-it-to-server&quot;</span><span class="o">&gt;</span><span class="n">relay</span> <span class="n">it</span> <span class="n">to</span> <span class="n">server</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">serversocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg3</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Sent</span> <span class="n">xmpp_msg3</span> <span class="p">(</span><span class="n">STARTTLS</span><span class="p">)</span> <span class="n">to</span> <span class="n">server</span><span class="err">”</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;receive-xmppmsg4-from-server&quot;</span><span class="o">&gt;</span><span class="n">receive</span> <span class="n">xmpp_msg4</span> <span class="kn">from</span> <span class="nn">server</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">xmpp_msg4</span> <span class="o">=</span> <span class="n">serversocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="n">xmpp_msg4</span> <span class="p">(</span><span class="n">PROCEED</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">server</span><span class="p">:</span>\<span class="n">n</span><span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span><span class="p">(</span><span class="n">xmpp_msg4</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;this-should-be-proceed&quot;</span><span class="o">&gt;</span><span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="n">PROCEED</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># &lt;proceed xmlns=&quot;urn:ietf:params:xml:ns:xmpp-tls&quot; /&gt;&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="err">“</span><span class="n">proceed</span><span class="err">”</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xmpp_msg4</span><span class="p">:</span>
    <span class="k">print</span> <span class="err">“</span>\<span class="n">n</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Something</span> <span class="n">went</span> <span class="n">wrong</span><span class="p">,</span> <span class="n">server</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">respond</span> <span class="k">with</span> <span class="n">proceed</span><span class="err">”</span>
    <span class="nb">exit</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">else</span><span class="p">:</span>
    <span class="n">clientsocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg4</span><span class="p">)</span>
    <span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">xmpp_msg4</span> <span class="p">(</span><span class="n">PROCEED</span><span class="p">)</span> <span class="n">to</span> <span class="n">client</span><span class="err">”</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Going</span> <span class="n">TLS</span><span class="err">”</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;now-we-must-wrap-our-sockets-in-tls&quot;</span><span class="o">&gt;</span><span class="n">now</span> <span class="n">we</span> <span class="n">must</span> <span class="n">wrap</span> <span class="n">our</span> <span class="n">sockets</span> <span class="ow">in</span> <span class="n">TLS</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># fortunately this is very easy in Python&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;converting-clientsocket-to-tls&quot;</span><span class="o">&gt;</span><span class="n">converting</span> <span class="n">clientsocket</span> <span class="n">to</span> <span class="n">TLS</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># modify the path host.crt and host.key (if they are not in the same directory)</span>
<span class="n">tlsclient</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">clientsocket</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="err">”</span><span class="n">host</span><span class="o">.</span><span class="n">key</span><span class="err">”</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="err">”</span><span class="n">host</span><span class="o">.</span><span class="n">crt</span><span class="err">”</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;set-it-to-non-blocking&quot;</span><span class="o">&gt;</span><span class="nb">set</span> <span class="n">it</span> <span class="n">to</span> <span class="n">non</span><span class="o">-</span><span class="n">blocking</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">tlsclient</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;set-timeout-to-05-sec&quot;</span><span class="o">&gt;</span><span class="nb">set</span> <span class="n">timeout</span> <span class="n">to</span> <span class="mf">0.5</span> <span class="n">sec</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">tlsclient</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;sslcertnone--cert-is-not-required-and-will-not-be-validated-if-provided&quot;</span><span class="o">&gt;</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span> <span class="o">==</span> <span class="n">cert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">validated</span> <span class="k">if</span> <span class="n">provided</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># this is not generally safe but we know the endpoint in this scenario</span>
<span class="c"># this means, don’t care if hipchatserver.com responds with a crappy certificate</span>
<span class="n">tlsserver</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">serversocket</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
<span class="n">tlsserver</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tlsserver</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;ssl-added-and-removed-here-&quot;</span><span class="o">&gt;</span><span class="n">SSL</span> <span class="n">added</span> <span class="ow">and</span> <span class="n">removed</span> <span class="n">here</span> <span class="p">:</span><span class="o">^</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># 2meta4me&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;now-we-are-going-to-juggle-connections&quot;</span><span class="o">&gt;</span><span class="n">now</span> <span class="n">we</span> <span class="n">are</span> <span class="n">going</span> <span class="n">to</span> <span class="n">juggle</span> <span class="n">connections</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># listen on one for half a second and send on the other one then vice versa&lt;/p&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># receive on client-side</span>
        <span class="n">msg_from_client</span> <span class="o">=</span> <span class="n">tlsclient</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span> <span class="err">“</span>\<span class="n">n</span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="kn">from</span> <span class="nn">client</span><span class="p">:</span>\<span class="n">n</span><span class="o">%</span><span class="n">s</span><span class="err">”</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_from_client</span><span class="p">)</span> <span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="n">tlsserver</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg_from_client</span><span class="p">)</span>
 
<span class="c"># sockets are non-blocking which means that they will timeout</span>
<span class="c"># here we check if they actually timedout</span>
<span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">socket_exception</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&quot;timed out&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Error receiving data from client</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">)</span>
 
<span class="k">try</span><span class="p">:</span>
    <span class="n">msg_from_server</span> <span class="o">=</span> <span class="n">tlsserver</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received from server:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_from_server</span><span class="p">)</span> <span class="p">)</span>
	
    <span class="n">tlsclient</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg_from_server</span><span class="p">)</span>
 
<span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">socket_exception</span><span class="p">:</span>
     <span class="k">if</span> <span class="s">&quot;timed out&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Error receiving data from server</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">)</span> 
</pre></div>