<div class="highlight"><pre><span class="c"># listen on 127.0.0.1:5222</span>
<span class="n">PROXY_HOST</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
<span class="n">PROXY_PORT</span> <span class="o">=</span> <span class="mi">5222</span>
 
<span class="c"># send everything to hipchatserver.com:5222</span>
<span class="n">REMOTE_HOST</span> <span class="o">=</span> <span class="s">&quot;10.11.1.25&quot;</span>  <span class="c"># hipchatserver.com</span>
<span class="n">REMOTE_PORT</span> <span class="o">=</span> <span class="mi">5222</span>
 
<span class="c"># buffer size in bytes</span>
<span class="c"># we will need such a large buffer because server will send a lot of data after the connection is established</span>
<span class="n">BUF_SIZE</span> <span class="o">=</span> <span class="mi">8192</span>
 
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span><span class="p">,</span> <span class="n">unhexlify</span>
 
<span class="c"># create socket 127.0.0.1:5222</span>
 
<span class="c">#  this can&#39;t be non-blocking for obvious reasons</span>
<span class="n">listensocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
 
<span class="c"># bind it to 127.0.0.1:5222</span>
<span class="n">listensocket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">PROXY_HOST</span><span class="p">,</span> <span class="n">PROXY_PORT</span><span class="p">))</span>
<span class="n">listensocket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># 1 for now - you can add more if you want multiple clients but we only need one</span>
 
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Created socket on </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> and listening&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PROXY_HOST</span><span class="p">,</span> <span class="n">PROXY_PORT</span><span class="p">)</span>
 
<span class="c"># now accept connections from hipchat client</span>
<span class="n">clientsocket</span><span class="p">,</span> <span class="n">clientaddress</span> <span class="o">=</span> <span class="n">listensocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
 
<span class="c"># this should be localhost or 127.0.0.1</span>
<span class="c"># str is needed because otherwise it cannot be printed properly and we get an errors</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Accepted connection from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">clientaddress</span><span class="p">)</span>
 
<span class="c"># listen for xmpp_msg1 (first step of XMPP  handshake)</span>
<span class="n">xmpp_msg1</span> <span class="o">=</span> <span class="n">clientsocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received msg from client:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmpp_msg1</span><span class="p">)</span>
 
<span class="c"># create a connection to srver and send it</span>
<span class="n">serversocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span> <span class="p">(</span><span class="n">REMOTE_HOST</span><span class="p">,</span> <span class="n">REMOTE_PORT</span><span class="p">)</span> <span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Connected to server at </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">REMOTE_HOST</span><span class="p">,</span> <span class="n">REMOTE_PORT</span><span class="p">)</span>
 
<span class="c"># send xmpp_msg1</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg1</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Sending xmpp_msg1 to server&quot;</span>
 
<span class="c"># receive xmpp_msg2 from server</span>
<span class="n">xmpp_msg2</span> <span class="o">=</span> <span class="n">serversocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received msg from server:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">xmpp_msg2</span><span class="p">)</span>
 
<span class="c"># relay it to client</span>
<span class="n">clientsocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg2</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Send xmpp_msg2 to client&quot;</span>
 
<span class="c"># receive xmpp_msg3</span>
<span class="n">xmpp_msg3</span> <span class="o">=</span> <span class="n">clientsocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received xmpp_msg3 (STARTTLS) from client:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmpp_msg3</span><span class="p">)</span>
 
<span class="c"># this should be the STARTTLS one</span>
<span class="c"># &lt;starttls xmlns=&#39;urn:ietf:params:xml:ns:xmpp-tls&#39;/&gt;</span>
 
<span class="c"># relay it to server</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg3</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Sent xmpp_msg3 (STARTTLS) to server&quot;</span>
 
<span class="c"># receive xmpp_msg4 from server</span>
<span class="n">xmpp_msg4</span> <span class="o">=</span> <span class="n">serversocket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received xmpp_msg4 (PROCEED) from server:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">xmpp_msg4</span><span class="p">)</span>
 
<span class="c"># this should be PROCEED</span>
<span class="c"># &lt;proceed xmlns=&#39;urn:ietf:params:xml:ns:xmpp-tls&#39;/&gt;</span>
 
<span class="k">if</span> <span class="s">&quot;proceed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xmpp_msg4</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> [+] Something went wrong, server did not respond with proceed&quot;</span>
    <span class="nb">exit</span><span class="p">()</span>
 
<span class="k">else</span><span class="p">:</span>
    <span class="n">clientsocket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">xmpp_msg4</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Sending xmpp_msg4 (PROCEED) to client&quot;</span>
 
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Going TLS&quot;</span>
 
<span class="c"># now we must wrap our sockets in TLS</span>
<span class="c"># fortunately this is very easy in Python</span>
 
<span class="c"># converting clientsocket to TLS</span>
<span class="c"># modify the path host.crt and host.key (if they are not in the same directory)</span>
<span class="n">tlsclient</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">clientsocket</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s">&quot;host.key&quot;</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="s">&quot;host.crt&quot;</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
 
<span class="c"># set it to non-blocking</span>
<span class="n">tlsclient</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 
<span class="c"># set timeout to 0.5 sec</span>
<span class="n">tlsclient</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
 
<span class="c"># ssl.CERT_NONE == cert is not required and will not be validated if provided</span>
<span class="c"># this is not generally safe but we know the endpoint in this scenario</span>
<span class="c"># this means, don&#39;t care if hipchatserver.com responds with a crappy certificate</span>
<span class="n">tlsserver</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">serversocket</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
<span class="n">tlsserver</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tlsserver</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
 
<span class="c"># SSL added and removed here :^)</span>
<span class="c"># 2meta4me</span>
 
<span class="c"># now we are going to juggle connections</span>
<span class="c"># listen on one for half a second and send on the other one then vice versa</span>
 
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># receive on client-side</span>
        <span class="n">msg_from_client</span> <span class="o">=</span> <span class="n">tlsclient</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received from client:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_from_client</span><span class="p">)</span> <span class="p">)</span>
 
        <span class="n">tlsserver</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg_from_client</span><span class="p">)</span>
 
	<span class="c"># sockets are non-blocking which means that they will timeout</span>
	<span class="c"># here we check if they actually timedout</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">socket_exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;timed out&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Error receiving data from client</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">)</span>
 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg_from_server</span> <span class="o">=</span> <span class="n">tlsserver</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Received from server:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_from_server</span><span class="p">)</span> <span class="p">)</span>
		
        <span class="n">tlsclient</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg_from_server</span><span class="p">)</span>
 
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">socket_exception</span><span class="p">:</span>
         <span class="k">if</span> <span class="s">&quot;timed out&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">[+] Error receiving data from server</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_exception</span><span class="p">)</span>
</pre></div>