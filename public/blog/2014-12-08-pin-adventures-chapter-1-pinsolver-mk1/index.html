
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pin Adventures - Chapter 1 - PinSolver MK1 - Parsiya's Den</title>
  <meta name="author" content="Parsiya">

  
  <meta name="description" content="While writing the writeups for the Flare On Challenge 6 I came upon an alternative solution by @gaasedelen to use the number of executed instructions &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://parsiya.net/blog/2014-12-08-pin-adventures-chapter-1-pinsolver-mk1">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Parsiya's Den" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55491306-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Parsiya's Den</a></h1>
  
    <h2>A n00b reverser's adventures down the rabbit hole.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:parsiya.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <!-- <li><a href="/about.html">About Me</a></li> -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Pin Adventures - Chapter 1 - PinSolver MK1</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-08T20:46:59-05:00" pubdate data-updated="true">Dec 8<span>th</span>, 2014</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://parsiya.net">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>While writing the writeups for the <a href="http://parsiya.net/blog/2014-10-07-my-adventure-with-fireeye-flare-challenge/#ch6">Flare On Challenge 6</a> I came upon <a href="http://gaasedelen.blogspot.com/2014/09/solving-fireeyes-flare-on-six-via-side.html">an alternative solution</a> by <a href="https://twitter.com/gaasedelen">@gaasedelen</a> to use the number of executed instructions as a side-channel. Recently during an engagement I used <a href="https://software.intel.com/en-us/articles/pintool">Pintool</a> to do <code>[redacted]</code>. Now that I have a bit of time, I decided to use the idea to write such a tool.</p>

<p>As an example, we will use a C program that checks input for a hardcoded value using <code>strncmp</code>. We want to see if it’s vulnerable to this side-channel (number of executed instructions).</p>

<!-- more -->

<h2 id="my-setup">My Setup</h2>
<p>I will be using a Kali 32-bit VM using VirtualBox. Installing Pin is as simple as extracting the appropriate distribution in a directory and adding it to path.</p>

<h3 id="pintool">Pintool</h3>
<p>Pin is a dynamic binary instrumentation framework by Intel. The default installation contains a good number of examples in <code>/pintool/source/tools/ManualExamples/</code>. If you look at various tutorials on it, most will use instruction count example in <code>inscount0.cpp</code>. I will be simplifying it to suit our needs and do <em>some</em> comments.</p>

<p>Here is the modified code. Let’s name it <code>myins.cpp</code> and save it in the ManualExamples directory. Apologies for the legal stuff at the start of the code but I’d rather keep them than risk the wrath of opensource gods.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myins.c </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
</pre></td><td class="code"><pre><code class="cpp"><span class="line"><span class="cm">/*BEGIN_LEGAL </span>
</span><span class="line"><span class="cm">Intel Open Source License </span>
</span><span class="line">
</span><span class="line"><span class="cm">Copyright (c) 2002-2014 Intel Corporation. All rights reserved.</span>
</span><span class="line"><span class="cm"> </span>
</span><span class="line"><span class="cm">Redistribution and use in source and binary forms, with or without</span>
</span><span class="line"><span class="cm">modification, are permitted provided that the following conditions are</span>
</span><span class="line"><span class="cm">met:</span>
</span><span class="line">
</span><span class="line"><span class="cm">Redistributions of source code must retain the above copyright notice,</span>
</span><span class="line"><span class="cm">this list of conditions and the following disclaimer.  Redistributions</span>
</span><span class="line"><span class="cm">in binary form must reproduce the above copyright notice, this list of</span>
</span><span class="line"><span class="cm">conditions and the following disclaimer in the documentation and/or</span>
</span><span class="line"><span class="cm">other materials provided with the distribution.  Neither the name of</span>
</span><span class="line"><span class="cm">the Intel Corporation nor the names of its contributors may be used to</span>
</span><span class="line"><span class="cm">endorse or promote products derived from this software without</span>
</span><span class="line"><span class="cm">specific prior written permission.</span>
</span><span class="line"><span class="cm"> </span>
</span><span class="line"><span class="cm">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
</span><span class="line"><span class="cm">``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
</span><span class="line"><span class="cm">LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
</span><span class="line"><span class="cm">A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE INTEL OR</span>
</span><span class="line"><span class="cm">ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
</span><span class="line"><span class="cm">SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
</span><span class="line"><span class="cm">LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
</span><span class="line"><span class="cm">DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
</span><span class="line"><span class="cm">THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
</span><span class="line"><span class="cm">(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
</span><span class="line"><span class="cm">OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
</span><span class="line"><span class="cm">END_LEGAL */</span>
</span><span class="line"><span class="cp">#include &lt;iostream&gt;</span>
</span><span class="line"><span class="cp">#include &quot;pin.H&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1">// The running count of instructions is kept here</span>
</span><span class="line"><span class="c1">// make it static to help the compiler optimize docount</span>
</span><span class="line"><span class="k">static</span> <span class="n">UINT64</span> <span class="n">icount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="c1">// This function is called before every instruction is executed</span>
</span><span class="line"><span class="c1">// increase the count everytime it is called, which is before every instruction</span>
</span><span class="line"><span class="n">VOID</span> <span class="n">docount</span><span class="p">()</span> <span class="p">{</span> <span class="n">icount</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// Pin calls this function every time a new instruction is encountered</span>
</span><span class="line"><span class="n">VOID</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">INS</span> <span class="n">ins</span><span class="p">,</span> <span class="n">VOID</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">// Insert a call to docount before every instruction, no arguments are passed</span>
</span><span class="line">    <span class="c1">// ins: instruction about to be executed</span>
</span><span class="line">    <span class="c1">// IPOINT_BEFORE: call is placed before each instruction</span>
</span><span class="line">    <span class="c1">// (AFUNPTR)docount: name of the function to call before every instruction</span>
</span><span class="line">    <span class="c1">// If any arguments areto be passed to the called function, they will be placed here</span>
</span><span class="line">    <span class="c1">// IARG_END: indicats the end of arguments</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// as a result before each instruction, docount is called</span>
</span><span class="line">    <span class="n">INS_InsertCall</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">IPOINT_BEFORE</span><span class="p">,</span> <span class="p">(</span><span class="n">AFUNPTR</span><span class="p">)</span><span class="n">docount</span><span class="p">,</span> <span class="n">IARG_END</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// This function is called when the application exits</span>
</span><span class="line"><span class="n">VOID</span> <span class="n">Fini</span><span class="p">(</span><span class="n">INT32</span> <span class="n">code</span><span class="p">,</span> <span class="n">VOID</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">// print the number of executed instructions</span>
</span><span class="line">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">icount</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/* ===================================================================== */</span>
</span><span class="line"><span class="cm">/* Print Help Message                                                    */</span>
</span><span class="line"><span class="cm">/* ===================================================================== */</span>
</span><span class="line">
</span><span class="line"><span class="n">INT32</span> <span class="n">Usage</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;This tool counts the number of dynamic instructions executed&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/* ===================================================================== */</span>
</span><span class="line"><span class="cm">/* Main                                                                  */</span>
</span><span class="line"><span class="cm">/* ===================================================================== */</span>
</span><span class="line"><span class="cm">/*   argc, argv are the entire command line: pin -t &lt;toolname&gt; -- ...    */</span>
</span><span class="line"><span class="cm">/* ===================================================================== */</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="c1">// Initialize pin</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">PIN_Init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">))</span> <span class="k">return</span> <span class="n">Usage</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Register Instruction to be called to instrument instructions</span>
</span><span class="line">    <span class="n">INS_AddInstrumentFunction</span><span class="p">(</span><span class="n">Instruction</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Register Fini to be called when the application exits</span>
</span><span class="line">    <span class="n">PIN_AddFiniFunction</span><span class="p">(</span><span class="n">Fini</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Start the program, never returns</span>
</span><span class="line">    <span class="n">PIN_StartProgram</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To compile it, we can use the provided makefile. In ManualExamples run <code>make obj-ia32/myins.so</code>. Note the filename and path. If everything works correctly, we will have <code>myins.so</code>. Let’s copy it to where we want to write our example program.</p>

<h3 id="crackme-1---example-c-program">Crackme 1 - Example C Program</h3>
<p>The progam is quite simple, it checks the first argument against the hardcoded value <code>7bc3a60fbf38e98f6fef654afa26d270</code>. We will use this program to test our Pin tool.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>crkme1.c </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="cpp"><span class="line"><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class="line"><span class="cp">#include &lt;string.h&gt;</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span><span class="o">!=</span><span class="mi">2</span> <span class="p">)</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./crkme1 code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;7bc3a60fbf38e98f6fef654afa26d270&quot;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">code</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span> <span class="p">)</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Correct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Remember to use the <code>ggdb</code> option to compile with debug information (for GDB). From what I understand this is very similar to the <code>g</code> option. We will be using GDB to dive into the binary to observe strncmp’s behavior. Let’s use <code>gcc -ggdb -o crkme1 crkme1.c</code>.</p>

<h3 id="using-pin-with-crkme1">Using Pin with Crkme1</h3>
<p>To run our Pin tool against any executable execute <code>pin -t myins.so -- ./crkme1 012345</code>. Now let’s experiment with some input. Our super secret code starts with <code>7b</code> so I will be <code>fuzzing</code> (for very simplisitic definition of fuzzing) the first character and look at the number of executed instructions.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Changing first character </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 1zzz
</span><span class="line">Wrong
</span><span class="line">Count: 100013
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 5zzz
</span><span class="line">Wrong
</span><span class="line">Count: 100013
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 7zzz
</span><span class="line">Wrong
</span><span class="line">Count: 100015 <span class="c"># interesting</span>
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 bzzz
</span><span class="line">Wrong
</span><span class="line">Count: 100013
</span><span class="line"><span class="nv">$pin</span> -t myins.so -- ./crkme1 @zzz
</span><span class="line">Wrong
</span><span class="line">Count: 100013
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Notice a pattern? Seems like we executed two extra instructions when our first character matched. Assuming our theory is correct and we have the first character <code>7</code>, let’s experiment with the second character.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Changing second character </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 71zz
</span><span class="line">Wrong
</span><span class="line">Count: 100015
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 75zz
</span><span class="line">Wrong
</span><span class="line">Count: 100015
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 7bzz
</span><span class="line">Wrong
</span><span class="line">Count: 100017 <span class="c"># 2 extra instructions executed</span>
</span><span class="line"><span class="nv">$ </span>pin -t myins.so -- ./crkme1 7@zz
</span><span class="line">Wrong
</span><span class="line">Count: 100015
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>At this point you probably have a good idea why this is happening. But let’s look at the assembly code.</p>

<h3 id="gdb-and-strncmp">GDB and strncmp</h3>
<p>Good thing we compiled our binary with debug information. Let’s look at the assembly code for strncmp:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Running crkme1 in gdb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c"># q starts gdb in quiet mode</span>
</span><span class="line"><span class="nv">$ </span>gdb ./crkme1 -q
</span><span class="line">Reading symbols from /root/Desktop/kek/crkme1...done.
</span><span class="line"><span class="c"># putting a break on strncmp, this is possible because we compiled with -ggdb option</span>
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">break </span>strncmp
</span><span class="line">Breakpoint 1 at 0x8048350
</span><span class="line"><span class="c"># passing 7bzz as a run-time argument. r stands for run</span>
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> r 7bzz
</span><span class="line">Starting program: /root/Desktop/kek/crkme1 7bzz
</span><span class="line">
</span><span class="line">Breakpoint 1, 0xb7f82b80 in ?? <span class="o">()</span> from /lib/i386-linux-gnu/i686/cmov/libc.so.6
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> disass
</span><span class="line">No <span class="k">function </span>contains program counter <span class="k">for </span>selected frame.
</span><span class="line"><span class="c"># oops what happened here?</span>
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To get a better a picture of the problem, we’re going to go through the same process in verbose mode in GDB using the <code>set verbose on</code> command.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Running in gdb with verbose on </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>gdb ./crkme1 -q
</span><span class="line">Reading symbols from /root/Desktop/kek/crkme1...done.
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set </span>verbose on
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">break </span>strncmp
</span><span class="line">Breakpoint 1 at 0x8048350
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> r 7bzz
</span><span class="line">Starting program: /root/Desktop/kek/crkme1 7bzz
</span><span class="line">Reading symbols from /lib/ld-linux.so.2...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class="line">Loaded symbols <span class="k">for</span> /lib/ld-linux.so.2
</span><span class="line">Reading symbols from system-supplied DSO at 0xb7fe1000...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class="line"><span class="c"># aha, no debugging symbols found for libc6</span>
</span><span class="line">Reading symbols from /lib/i386-linux-gnu/i686/cmov/libc.so.6...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class="line">Loaded symbols <span class="k">for</span> /lib/i386-linux-gnu/i686/cmov/libc.so.6
</span><span class="line">
</span><span class="line">Breakpoint 1, 0xb7f82b80 in ?? <span class="o">()</span> from /lib/i386-linux-gnu/i686/cmov/libc.so.6
</span><span class="line"><span class="o">(</span>gdb<span class="o">)</span> disass
</span><span class="line">No <span class="k">function </span>contains program counter <span class="k">for </span>selected frame.
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>According to line 12, we we need the debugging symbols for libc to look inside the code. 
On Kali use <code>apt-get install libc6-dbg</code>. Here we go again:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>After installing libc6-dbg </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="nasm"><span class="line"><span class="nl">root@kali:</span><span class="err">~/</span><span class="nf">Desktop</span><span class="o">/</span><span class="nv">kek#</span> <span class="nv">gdb</span> <span class="nv">.</span><span class="o">/</span><span class="nv">crkme1</span> <span class="o">-</span><span class="nv">q</span>
</span><span class="line"><span class="nf">Reading</span> <span class="nv">symbols</span> <span class="nv">from</span> <span class="o">/</span><span class="nv">root</span><span class="o">/</span><span class="nv">Desktop</span><span class="o">/</span><span class="nv">kek</span><span class="o">/</span><span class="nv">crkme1...done.</span>
</span><span class="line"><span class="err">(</span><span class="nf">gdb</span><span class="p">)</span> <span class="nv">break</span> <span class="nv">strncmp</span>
</span><span class="line"><span class="nf">Breakpoint</span> <span class="mi">1</span> <span class="nv">at</span> <span class="mh">0x8048350</span>
</span><span class="line"><span class="err">(</span><span class="nf">gdb</span><span class="p">)</span> <span class="nv">r</span> <span class="mi">7</span><span class="nv">bzz</span>
</span><span class="line"><span class="nf">Starting</span> <span class="nv">program</span><span class="p">:</span> <span class="o">/</span><span class="nv">root</span><span class="o">/</span><span class="nv">Desktop</span><span class="o">/</span><span class="nv">kek</span><span class="o">/</span><span class="nv">crkme1</span> <span class="mi">7</span><span class="nv">bzz</span>
</span><span class="line">
</span><span class="line"><span class="nf">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">__strncmp_ssse3</span> <span class="p">()</span>
</span><span class="line">    <span class="nf">at</span> <span class="nv">..</span><span class="o">/</span><span class="nv">sysdeps</span><span class="o">/</span><span class="nv">i386</span><span class="o">/</span><span class="nv">i686</span><span class="o">/</span><span class="nv">multiarch</span><span class="o">/</span><span class="nv">strcmp</span><span class="o">-</span><span class="nb">ss</span><span class="nv">se3.S</span><span class="p">:</span><span class="mi">65</span>
</span><span class="line"><span class="err">65</span>	<span class="nf">..</span><span class="o">/</span><span class="nv">sysdeps</span><span class="o">/</span><span class="nv">i386</span><span class="o">/</span><span class="nv">i686</span><span class="o">/</span><span class="nv">multiarch</span><span class="o">/</span><span class="nv">strcmp</span><span class="o">-</span><span class="nb">ss</span><span class="nv">se3.S</span><span class="p">:</span> <span class="nv">No</span> <span class="nv">such</span> <span class="nv">file</span> <span class="nv">or</span> <span class="nb">di</span><span class="nv">rectory.</span>
</span><span class="line"><span class="err">(</span><span class="nf">gdb</span><span class="p">)</span> <span class="nb">di</span><span class="nv">sass</span>
</span><span class="line"><span class="nf">Dump</span> <span class="nv">of</span> <span class="nv">assembler</span> <span class="nv">code</span> <span class="nv">for</span> <span class="nv">function</span> <span class="nv">__strncmp_ssse3</span><span class="p">:</span>
</span><span class="line"><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">xb7f82b80</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">push</span>   <span class="nb">ebp</span>
</span><span class="line">   <span class="err">0</span><span class="nf">xb7f82b81</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
</span><span class="line">   <span class="err">0</span><span class="nf">xb7f82b85</span> <span class="o">&lt;+</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>
</span><span class="line">   <span class="err">0</span><span class="nf">xb7f82b89</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">ebp</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
</span><span class="line">   <span class="err">0</span><span class="nf">xb7f82b8d</span> <span class="o">&lt;+</span><span class="mi">13</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">ebp</span><span class="p">,</span><span class="mh">0x10</span>
</span><span class="line">   <span class="err">0</span><span class="nf">xb7f82b90</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jb</span>     <span class="mh">0xb7f843d0</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6224</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we can see what happens in strncmp. The following is the cleaned up version of the assembly of strncmp.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>strncmp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="nasm"><span class="line"><span class="c1">; assuming we called strncmp (argv[1],code,32);</span>
</span><span class="line">
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b80</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">push</span>   <span class="nb">ebp</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b81</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span> 	<span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>  <span class="c1">; argv[1] or &quot;7bzz&quot;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b85</span> <span class="o">&lt;+</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">:</span> 	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>  <span class="c1">; code or &quot;7bc3 ..&quot;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b89</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span> 	<span class="nv">mov</span>    <span class="nb">ebp</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span> <span class="c1">; 32 or 0x20</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b8d</span> <span class="o">&lt;+</span><span class="mi">13</span><span class="o">&gt;</span><span class="p">:</span> 	<span class="nv">cmp</span>    <span class="nb">ebp</span><span class="p">,</span><span class="mh">0x10</span>                 <span class="c1">; 32 compared to 0x10 (16 decimal)</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f82b90</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span> 	<span class="nv">jb</span>     <span class="mh">0xb7f843d0</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6224</span><span class="o">&gt;</span>
</span><span class="line"><span class="nf">...</span>
</span><span class="line"><span class="c1">; if number of bytes to compare is bigger than 16</span>
</span><span class="line"><span class="c1">; let&#39;s assume it is and see what happens next</span>
</span><span class="line"><span class="nf">...</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843d0</span> <span class="o">&lt;+</span><span class="mi">6224</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">test</span>   <span class="nb">ebp</span><span class="p">,</span><span class="nb">ebp</span>  <span class="c1">; if (ebp == 0) goto 0xb7f843c3</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843d2</span> <span class="o">&lt;+</span><span class="mi">6226</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6211</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843d4</span> <span class="o">&lt;+</span><span class="mi">6228</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">ecx</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span> <span class="c1">; ecx = code</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843d7</span> <span class="o">&lt;+</span><span class="mi">6231</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">edx</span><span class="p">],</span><span class="nb">cl</span>  <span class="c1">; if (code[0] != argv[1][0]) goto 0xb7f843b0;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843d9</span> <span class="o">&lt;+</span><span class="mi">6233</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jne</span>    <span class="mh">0xb7f843b0</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6192</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843db</span> <span class="o">&lt;+</span><span class="mi">6235</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">test</span>   <span class="nb">cl</span><span class="p">,</span><span class="nb">cl</span>  <span class="c1">; if (code[0] == 0) goto 0xb7f843c3; // have we reached the end of code?</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843dd</span> <span class="o">&lt;+</span><span class="mi">6237</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6211</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843df</span> <span class="o">&lt;+</span><span class="mi">6239</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">ebp</span><span class="p">,</span><span class="mh">0x1</span>  <span class="c1">; if (counter == 1) goto 0xb7f843c3; // was this our last compare?</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843e2</span> <span class="o">&lt;+</span><span class="mi">6242</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6211</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843e4</span> <span class="o">&lt;+</span><span class="mi">6244</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">ecx</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="o">+</span><span class="mh">0x1</span><span class="p">]</span>	<span class="c1">; ecx = code[1];</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843e8</span> <span class="o">&lt;+</span><span class="mi">6248</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">edx</span><span class="o">+</span><span class="mh">0x1</span><span class="p">],</span><span class="nb">cl</span>  <span class="c1">; if (code[1] != argv[1][1]) goto 0xb7f843b0;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843eb</span> <span class="o">&lt;+</span><span class="mi">6251</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jne</span>    <span class="mh">0xb7f843b0</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6192</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843ed</span> <span class="o">&lt;+</span><span class="mi">6253</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">test</span>   <span class="nb">cl</span><span class="p">,</span><span class="nb">cl</span>  <span class="c1">; if (code[1] == 0) goto 0xb7f843c3; // have we reached the end of code?</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843ef</span> <span class="o">&lt;+</span><span class="mi">6255</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6211</span><span class="o">&gt;</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843f1</span> <span class="o">&lt;+</span><span class="mi">6257</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">ebp</span><span class="p">,</span><span class="mh">0x2</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f843f4</span> <span class="o">&lt;+</span><span class="mi">6260</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">6211</span><span class="o">&gt;</span>
</span><span class="line"><span class="nf">...</span>
</span><span class="line"><span class="c1">; similar byte compares until the end</span>
</span><span class="line"><span class="nf">...</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f8453f</span> <span class="o">&lt;+</span><span class="mi">6591</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">test</span>   <span class="nb">cl</span><span class="p">,</span><span class="nb">cl</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f84541</span> <span class="o">&lt;+</span><span class="mi">6593</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">621</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f84547</span> <span class="o">&lt;+</span><span class="mi">6599</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">ebp</span><span class="p">,</span><span class="mh">0xf</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f8454a</span> <span class="o">&lt;+</span><span class="mi">6602</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0xb7f843c3</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">621</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f84550</span> <span class="o">&lt;+</span><span class="mi">6608</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">ecx</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="o">+</span><span class="mh">0xf</span><span class="p">]</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f84554</span> <span class="o">&lt;+</span><span class="mi">6612</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">edx</span><span class="o">+</span><span class="mh">0xf</span><span class="p">],</span><span class="nb">cl</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f84557</span> <span class="o">&lt;+</span><span class="mi">6615</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jne</span>    <span class="mh">0xb7f843b0</span> <span class="o">&lt;</span><span class="nv">__strncmp_ssse3</span><span class="o">+</span><span class="mi">619</span>
</span><span class="line"><span class="err">0</span><span class="nf">xb7f8455d</span> <span class="o">&lt;+</span><span class="mi">6621</span><span class="o">&gt;</span><span class="c1">;	test   cl,cl</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We can see that the implementation has unrolled the for and compares 16 bytes one by one. If a character is correct, two more instructions are executed (as we saw) which are <code>test   cl,cl</code> and <code>je     0xb7f843c3</code> which basically checks if we have reached the end of first string. Now we know why. Let us build our tool.</p>

<h3 id="pinsolver-mk1">PinSolver MK1</h3>
<p>I am going to use Python’s subprocess module and reuse <a href="http://parsiya.net/blog/2014-05-25-pasting-shellcode-into-gdb-using-python/">some old code</a>. The script simply iterates through all valid characters (note: do not include space or some other special characters). For this example I am going to use alphanumeric characters. Character with the largest number of executed instructions will be chose and we move on to the next character.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Parsiya</span></span>

      








  


<time datetime="2014-12-08T20:46:59-05:00" pubdate data-updated="true">Dec 8<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/pin/'>PIN</a>, <a class='category' href='/blog/categories/pin-tool/'>PIN tool</a>, <a class='category' href='/blog/categories/pinsolver/'>PINSolver</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014-11-18-building-memfetch-on-kali/" title="Previous Post: Building memfetch on Kali + Comments">&laquo; Building memfetch on Kali + Comments</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Who am I?</h1>
  <p>I am Parsia Hakimian, ex-dev and current (mostly) software security consultant at <a href="http://www.cigital.com/" target="_blank">Cigital</a> .</p>
  <p>I am interested in Reverse Engineering, Crypto, Assembly, C, Python, EvE Online and other things (not necessarily in that order).</p>
  <p>bitbucket: <a href="https://bitbucket.org/parsiya/" target="_blank">https://bitbucket.org/parsiya/</a></p>
  <p>email: parsiya [at] google's email [dot]com</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014-12-08-pin-adventures-chapter-1-pinsolver-mk1/">Pin Adventures - Chapter 1 - PinSolver MK1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-11-18-building-memfetch-on-kali/">Building Memfetch on Kali + Comments</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-10-07-my-adventure-with-fireeye-flare-challenge/">My Adventure With Fireeye FLARE Challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-09-21-malware-adventure/">Malware Adventure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-09-02-fireeyes-flare-challenge/">Fireeye's FLARE Challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-07-03-apples-common-crypto-library-defaults-to-a-zero-iv-if-one-is-not-provided/">Apple's Common Crypto Library Defaults to a Zero IV if One Is Not Provided</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-06-25-piping-ssl-slash-tls-traffic-from-soapui-through-burp/">Piping SSL/TLS Traffic From SoapUI to Burp</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-05-25-pasting-shellcode-into-gdb-using-python/">Pasting Shellcode in GDB Using Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-04-22-amazon-s3-and-css/">Amazon S3 and CSS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014-04-20-now-hosted-on-amazon-s3/">Now Hosted on Amazon S3</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Twitter</h1>
    <a class="twitter-timeline"  href="https://twitter.com/CryptoGangsta"  data-widget-id="458841047112482817">Tweets by @CryptoGangsta</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Parsiya -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'parsiya';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://parsiya.net/blog/2014-12-08-pin-adventures-chapter-1-pinsolver-mk1/';
        var disqus_url = 'http://parsiya.net/blog/2014-12-08-pin-adventures-chapter-1-pinsolver-mk1/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
