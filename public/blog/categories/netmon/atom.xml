<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Netmon | Parsiya's Den]]></title>
  <link href="http://parsiya.net/blog/categories/netmon/atom.xml" rel="self"/>
  <link href="http://parsiya.net/"/>
  <updated>2015-10-10T00:01:41-04:00</updated>
  <id>http://parsiya.net/</id>
  <author>
    <name><![CDATA[Parsiya]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Proxying Hipchat Part 1: Where Did the Traffic Go?]]></title>
    <link href="http://parsiya.net/blog/2015-10-08-hipchat-part-1-where-did-the-traffic-go/"/>
    <updated>2015-10-08T23:05:24-04:00</updated>
    <id>http://parsiya.net/blog/hipchat-part-1-where-did-the-traffic-go</id>
    <content type="html"><![CDATA[<p>This is a slightly different version of a series of blog post that I wrote on our internal blog about proxying. I see that proxying traffic is a time consuming step in testing thick client applications so I thought I would share what I know. I tackled Hipchat. Why Hipchat? Because it uses a known protocol (XMPP) and I thought it’s an interesting application.</p>

<p>I used Hipchat Windows client version 2. At the time of writing version 4 is in beta. In this part we will see how we can identify endpoints from traffic captures even when they are behind a load balancer/shared hosting etc. In next parts we will start proxying.</p>

<!-- more -->

<h3 id="setup-and-tools">0. Setup and Tools</h3>
<p>I will be using the following tools in this part:</p>

<ol>
  <li>Microsoft Network Monitor (Netmon). You can also use Wireshark.</li>
  <li>Powershell/Command Prompt/etc: I am using Windows but I am sure you can find the equivalent commands if you are fancy ;)</li>
  <li>Procmon</li>
</ol>

<p>You can deploy your own Hipchat server by <a href="https://www.hipchat.com/server/get-it">downloading a VM</a>. </p>

<p>Note: In these posts, the Hipchat server is named <code>hipchatserver.com</code> and its IP is <code>10.10.10.10</code> (these are just examples). Some of the screenshots are edited to hide the actual IPs and replace them with samples. My machine’s sample IP address for the network interface that hosts the Hipchat server is <code>10.10.10.9</code>.</p>

<h3 id="traffic-attribution">1. Traffic Attribution</h3>
<p>Run Netmon and Procmon as admin and run HipChat. We already know how to do <a href="../2015-08-01-network-traffic-attribution-on-windows">network traffic attribution</a>. I was not logged into any chatrooms, so Hipchat is not loading any extra content (e.g. images linked in rooms).</p>

<p>In Netmon we also see the following endpoints:</p>

<ol>
  <li>10.10.10.10</li>
  <li>54.231.81.2</li>
  <li>54.231.96.96</li>
  <li>54.231.47.194</li>
  <li>54.225.209.74</li>
</ol>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-20">
    <img src="/images/2015/hipchat1/01-Traffic-in-Netmon.png"
         width="1085" height="366"
         alt="Click me."/>
  </a>
  <div id="image-dialog-20" style="display:none">
    <img src="/images/2015/hipchat1/01-Traffic-in-Netmon.png"
         width="1356" height="457"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-20").hide();
    jQuery("#image-dialog-20").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1396,
      minHeight: 497,
      title:     "Traffic in Netmon ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-20").click(function() {
      jQuery("#image-dialog-20").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>Traffic in Netmon, click to view full-size image.</p>

<p>You will notice that I have a slightly different layout in Netmon now. I have removed time related columns. Right click any column name and select <code>Choose Columns</code>. There are also different layouts like <code>HTTP Troubleshoot</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/hipchat1/02-Endpoints-in-Netmon.png' width='' height='' title='Endpoints in Netmon'><span class='caption-text'>Endpoints in Netmon</span></span></p>

<p>In Procmon we can see five endpoints:</p>

<ol>
  <li>hipchatserver.com:5222</li>
  <li>s3-website-us-east-1.amazonaws.com:http</li>
  <li>s3-1.amazonaws.com:https</li>
  <li>ec2-54-531-47-194.compute-1.amazonaws.com:https</li>
  <li>ec2-54-225-209-74.compute-1.amazonaws.com:https</li>
</ol>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/hipchat1/03-Endpoints-in-Procmon.png' width='' height='' title='Endpoints in Procmon'><span class='caption-text'>Endpoints in Procmon</span></span></p>

<p>Procmon filters are:</p>

<ul>
  <li>ProcessName is Hipchat.exe</li>
  <li>Operation is TCP Connect</li>
</ul>

<h3 id="where-does-the-traffic-go">2. Where does the traffic go?</h3>
<p>Now we need to find out more about these endpoints (e.g. their actual address/URL etc). Based on their temporal sequence in Procmon and Netmon we have some insights.</p>

<h4 id="hipchatservercom">2.1 – 10.10.10.10 – hipchatserver.com</h4>
<p>This is easy. It’s the Hipchat server at <code>hipchatserver.com</code>.</p>

<pre><code>PS C:\&gt; nslookup 10.10.10.10
Server:  zzzz.com
Address:  10.10.10.2

Name:    hipchatserver.com
Address:  10.10.10.10

PS C:\&gt; ping -a 10.10.10.10
Pinging hipchatserver.com [10.10.10.10] with 32 bytes of data:
...
</code></pre>

<h4 id="s3-website-us-east-1amazonawscom">2.2 – 54.231.81.2 – s3-website-us-east-1.amazonaws.com</h4>
<p>This is where things start to become interesting. Let’s re-use our old tricks.</p>

<pre><code>PS C:\&gt; nslookup 54.231.81.2
Server:  zzzz.com
Address:  10.10.10.2

Name:    s3-website-us-east-1.amazonaws.com
Address:  54.231.81.2

PS C:\&gt; ping -a 54.231.81.2
Pinging s3-website-us-east-1.amazonaws.com [54.231.81.2] with 32 bytes of data:
...
</code></pre>

<p>It seems like the second endpoint is hosted on an AWS S3 bucket. S3 buckets are mainly storage containers but they can also host static websites like this website. But we won’t find anything if we go to that address. <code>s3-website-us-east-1.amazonaws.com</code> is the east coast AWS data center which is located in Northern Virginia. You will get a different endpoint based on where you are located.</p>

<p>Let’s look at the conversation in Netmon. This is similar to <code>Follow TCP/UDP Stream</code> in Wireshark but unfortunately not as good.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/hipchat1/04-bloginfo-fetch.png' width='' height='' title='Fetching blog_info.html'><span class='caption-text'>Fetching blog_info.html</span></span></p>

<p>We are in luck, we can see a <code>GET</code> request over HTTP. Let’s look at it’s payload:</p>

<pre><code>GET /blog_info.html HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/538.1 (KHTML, like Gecko) HipChat/2.2.1388 Safari/538.1
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en-US,*
Host: downloads.hipchat.com
</code></pre>

<p>Note the User-Agent. Hipchat is fetching <a href="http://downloads.hipchat.com/blog_info.html">http://downloads.hipchat.com/blog_info.html</a>. This is the <code>Latest News</code> at the bottom of the Hipchat client. Notice that it is being loaded over HTTP and surprisingly it is not available over TLS (try accessing <a href="https://downloads.hipchat.com/blog_info.html">https://downloads.hipchat.com/blog_info.html</a>) does not work. In fact you cannot access <a href="https://downloads.hipchat.com/">https://downloads.hipchat.com</a>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/hipchat1/05-Latest-news-in-hipchat.png' width='' height='' title='“Latest News” fetched over HTTP ;)'><span class='caption-text'>“Latest News” fetched over HTTP ;)</span></span></p>

<h5 id="but-what-if-this-request-was-over-tls">2.2.1 But what if this request was over TLS?</h5>
<p>Then we would have seen the TLS handshake and then encrypted data. Even by looking at the Common Name (CN) field in server’s certificate in 2nd part of the TLS handshake (<code>Server Hello</code>) we wouldn’t have been able to discover the endpoint.
Traffic in Netmon, click to view full-size image.
We are going to have to look at DNS requests. We know the endpoint’s IP address so we will try to find the DNS request that had this IP in its answer. The endpoint’s IP address is <code>54.231.81.2</code> which is <code>36E75102</code> in Hex. In Netmon, select <code>All Traffic</code> (In Netmon DNS traffic is not included in process traffic) and enter the following filter:</p>

<pre><code>  DNS &amp;&amp; ContainsBin(FrameData, HEX, "36E75102")
</code></pre>

<p>This filter searches for the IP address in DNS traffic. It will find the DNS query that returned this IP address.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/hipchat1/06-Downloads.png' width='' height='' title='downloads.hipchat.com'><span class='caption-text'>downloads.hipchat.com</span></span></p>

<p>As we can see, it is <code>downloads.hipchat.com</code>.</p>

<p>IP to Hex conversion can be done online, by hand or using Python:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>IP to Hex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">PS</span> <span class="n">C</span><span class="p">:</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">python</span>
</span><span class='line'><span class="err">»</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="err">»</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>
</span><span class='line'><span class="err">»</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="k">print</span> <span class="n">hexlify</span> <span class="p">(</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="err">“</span><span class="mf">54.231</span><span class="o">.</span><span class="mf">81.2</span><span class="err">”</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="mf">36e75102</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h4 id="s3-1amazonawscom">2.3 – 54.231.96.96 – s3-1.amazonaws.com</h4>

<p>Same trick. <code>54.231.96.96</code> in Hex is <code>36E76060</code> so filter is:</p>

<pre><code>  DNS &amp;&amp; ContainsBin(FrameData, HEX, "36E76060")
</code></pre>

<p>which points to <code>s3.amazonaws.com</code>. As we will see in part two, this is the request to load the emoticon shown with latest news, in this case it is the <code>success kid</code> image macro.</p>

<pre><code>- Dns: QueryId = 0xC28D, QUERY (Standard query), Response - Success, 53, 0 ... 
    QueryIdentifier: 49805 (0xC28D)
  + Flags:  Response, Opcode - QUERY (Standard query), RD, RA, Rcode - Success
    QuestionCount: 1 (0x1)
    AnswerCount: 3 (0x3)
    NameServerCount: 0 (0x0)
    AdditionalCount: 0 (0x0)
  - QRecord: s3.amazonaws.com of type Host Addr on class Internet  PS C:\&gt; python
     QuestionName: s3.amazonaws.com
     QuestionType: A, IPv4 address, 1(0x1)
     QuestionClass: Internet, 1(0x1)
  - ARecord: s3.amazonaws.com of type CNAME on class Internet: s3.a-geo.amazonaws.com
     ResourceName: s3.amazonaws.com
     ResourceType: CNAME, Canonical name for an alias, 5(0x5)
     ResourceClass: Internet, 1(0x1)
     TimeToLive: 2554 (0x9FA)
     ResourceDataLength: 11 (0xB)
     CName: s3.a-geo.amazonaws.com
  - ARecord: s3.a-geo.amazonaws.com of type CNAME on class Internet: s3-1.amazonaws.com
     ResourceName: s3.a-geo.amazonaws.com
     ResourceType: CNAME, Canonical name for an alias, 5(0x5)
     ResourceClass: Internet, 1(0x1)
     TimeToLive: 1555 (0x613)
     ResourceDataLength: 7 (0x7)
     CName: s3-1.amazonaws.com
  - ARecord: s3-1.amazonaws.com of type Host Addr on class Internet: 54.231.96.96
     ResourceName: s3-1.amazonaws.com
     ResourceType: A, IPv4 address, 1(0x1)
     ResourceClass: Internet, 1(0x1)
     TimeToLive: 4 (0x4)
     ResourceDataLength: 4 (0x4)
     IPAddress: 54.231.96.96
</code></pre>

<h4 id="ec2-54-243-47-194compute-1amazonawscom">2.4 – 54.243.47.194 – ec2-54-243-47-194.compute-1.amazonaws.com</h4>
<p>This is easy, we can just go to <a href="http://ec2-54-243-47-194.compute-1.amazonaws.com">http://ec2-54-243-47-194.compute-1.amazonaws.com</a> and observe that it is <a href="http://www.hipchat.com">http://www.hipchat.com</a>. Interesting thing, if you go to <a href="http://www.hipchat.com">http://www.hipchat.com</a> in your browser, it will redirect to the HTTPs version of the website. Going to the Amazon EC2 address is the only way to access hipchat.com over HTTP.</p>

<p>We can also use this filter in Netmon:</p>

<pre><code>  DNS &amp;&amp; ContainsBin(FrameData, HEX, "36F32FC2")
</code></pre>

<p>Which results in:</p>

<pre><code>- Dns: QueryId = 0x1D07, QUERY (Standard query), Response - Success, 54.243.47.194 
    QueryIdentifier: 7431 (0x1D07)
  + Flags:  Response, Opcode - QUERY (Standard query), RD, RA, Rcode - Success
    QuestionCount: 1 (0x1)
    AnswerCount: 1 (0x1)
    NameServerCount: 0 (0x0)
    AdditionalCount: 0 (0x0)
  - QRecord: www.hipchat.com of type Host Addr on class Internet
     QuestionName: www.hipchat.com
     QuestionType: A, IPv4 address, 1(0x1)
     QuestionClass: Internet, 1(0x1)
  - ARecord: www.hipchat.com of type Host Addr on class Internet: 54.243.47.194
     ResourceName: www.hipchat.com
     ResourceType: A, IPv4 address, 1(0x1)
     ResourceClass: Internet, 1(0x1)
     TimeToLive: 60 (0x3C)
     ResourceDataLength: 4 (0x4)
     IPAddress: 54.243.47.194
</code></pre>

<h4 id="ec2-54-225-209-74compute-1amazonawscom">2.5 – 54.225.209.74 – ec2-54-225-209-74.compute-1.amazonaws.com</h4>
<p>This is the same as above with one small difference. Using this filter:</p>

<pre><code>DNS &amp;&amp; ContainsBin(FrameData, HEX, "36E1D14A")
</code></pre>

<p>We can see that is points to hipchat.com (last IP was <code>www.hipchat.com</code>).</p>

<pre><code>- Dns: QueryId = 0x280E, QUERY (Standard query), Response - Success, 54.225.209.74 
    QueryIdentifier: 10254 (0x280E)
  + Flags:  Response, Opcode - QUERY (Standard query), RD, RA, Rcode - Success
    QuestionCount: 1 (0x1)
    AnswerCount: 1 (0x1)
    NameServerCount: 0 (0x0)
    AdditionalCount: 0 (0x0)
  - QRecord: hipchat.com of type Host Addr on class Internet
     QuestionName: hipchat.com
     QuestionType: A, IPv4 address, 1(0x1)
     QuestionClass: Internet, 1(0x1)
  - ARecord: hipchat.com of type Host Addr on class Internet: 54.225.209.74
     ResourceName: hipchat.com
     ResourceType: A, IPv4 address, 1(0x1)
     ResourceClass: Internet, 1(0x1)
     TimeToLive: 59 (0x3B)
     ResourceDataLength: 4 (0x4)
     IPAddress: 54.225.209.74
</code></pre>

<p>So the application is communicating with both <code>www.hipchat.com</code> and <code>hipchat.com</code>. Probably because of a redirect as we can see later.</p>

<p>That’s enough for now. In part two we will talk about proxying.</p>

<!-- links -->

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Network Traffic Attribution on Windows]]></title>
    <link href="http://parsiya.net/blog/2015-08-01-network-traffic-attribution-on-windows/"/>
    <updated>2015-08-01T19:37:42-04:00</updated>
    <id>http://parsiya.net/blog/network-traffic-attribution-on-windows</id>
    <content type="html"><![CDATA[<p>Thick client assessments come in different flavors. Most of our work is on <code>consumer applications</code> where <code>consumer</code> means either the customer or an employee of our client. But these applications usually have network communications.</p>

<p>When looking at thick client applications from a network traffic perspective, we face two big challenges:</p>

<ol>
  <li>
    <p><strong>Traffic Attribution</strong> or <strong>Where does this traffic come from?</strong>: How to we identify application’s traffic? The operating system (in this case Windows) is running many applications and services. Each of them may have network connectivity.</p>
  </li>
  <li>
    <p><strong>Proxying Traffic</strong> or <strong>How do I look view/modify traffic?</strong>: This is more challenging and involves capturing, modifying and in a lot of cases decrypting/decoding target application’s traffic. This could be as easy as setting up Burp via an application setting (EZ-mode) or as hard as setting up your own access point to capture a device’s traffic then developing your own decryption plugin for your proxy tool (good luck).</p>
  </li>
</ol>

<p>In this post, I will be talking about the much easier first challenge. I will be talking about some of the tools and techniques that I use to accomplish this. This is not a groundbreaking post ;). We will use a simple application, in this case <code>notepad++</code>.</p>

<!-- more -->

<h3 id="our-setup">1. Our Setup</h3>

<p>I am using Windows 7 VM running via VirtualBox. You can probably use anything newer than Windows XP. You can get VMs from Microsoft at [http://dev.modern.ie/tools/vms/windows/][modern-ie]. These VMs have 90 day activation periods and are for testing different versions of IE but they are enough for our purpose. One downside is the huge virtual disk drive (110GB) that can be shrinked (from inside Windows) in half. Hard drive is still dynamically located but if you do not watch out, it wills tart filling up your hard drive (especially if you are making snapshots).</p>

<h3 id="list-of-tools">2. List of Tools</h3>

<ol>
  <li><strong>Microsoft Network Monitor (Netmon)</strong>: <a href="http://blogs.technet.com/b/netmon/p/downloads.aspx">http://blogs.technet.com/b/netmon/p/downloads.aspx</a></li>
  <li><strong>Wireshark</strong>: <a href="https://www.wireshark.org/download.html">https://www.wireshark.org/download.html</a></li>
  <li><strong>Process Monitor (Procmon)</strong>: Part of Microsoft Sysinternals Suite: <a href="https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx</a></li>
</ol>

<h3 id="test-application">3. Test Application</h3>

<p>I will be using <code>Notepad++ 6.7.9.2</code>. it was the current version at the time of writing but by the time I got to publishing this post it has been updated to version <code>6.8</code>. You can download it from <a href="https://notepad-plus-plus.org/download/v6.7.9.2.html">https://notepad-plus-plus.org/download/v6.7.9.2.html</a>. Install Notepad++ but make sure to select <code>Auto Updater</code> and <code>Plugin Manager</code> during installation. <strong>Do not run the application at the end of the installation process</strong>.</p>

<h3 id="traffic-attribution">4. Traffic Attribution</h3>

<p>Run Netmon, Wireshark and Procmon (as Administrator) then run <code>Notepad++</code>.</p>

<p><strong>Procmon Note</strong>: Never select <code>Drop Filtered Events</code> in the Filter menu. It will discard all events that are not shown by your filters. There is no going back to viewing filtered events.</p>

<h4 id="netmon">4.1 Netmon</h4>

<p>We can see a bunch of traffic in Netmon. See this handy tree view to the left? That is why we are using it ;).</p>

<p>Click on <code>notepad++.exe</code> in the tree view to view all of its traffic. We can see that it is communicating with <code>superb-dca2.dl.sourceforge.net</code> and <code>downloads.sourceforge.net</code> over HTTP <em>gasp</em>. You may observe a different endpoint depending on your location (because Source forge).</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-21">
    <img src="/images/2015/TrafficAttribution1/01.PNG"
         width="997" height="366"
         alt="Click me."/>
  </a>
  <div id="image-dialog-21" style="display:none">
    <img src="/images/2015/TrafficAttribution1/01.PNG"
         width="1246" height="458"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-21").hide();
    jQuery("#image-dialog-21").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1286,
      minHeight: 498,
      title:     "Notepad++ traffic in Netmon ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-21").click(function() {
      jQuery("#image-dialog-21").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>There’s another <code>suspicious process</code> up there. Select <code>gup.exe</code> and we can see it is also related to <code>Notepad++</code> as it’s creating a TLS connection to <code>notepad-plus-plus.org</code>.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-22">
    <img src="/images/2015/TrafficAttribution1/02.PNG"
         width="922" height="399"
         alt="Click me."/>
  </a>
  <div id="image-dialog-22" style="display:none">
    <img src="/images/2015/TrafficAttribution1/02.PNG"
         width="1153" height="499"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-22").hide();
    jQuery("#image-dialog-22").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1193,
      minHeight: 539,
      title:     "gup.exe traffic in Netmon ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-22").click(function() {
      jQuery("#image-dialog-22").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>But wait, there’s more. There may be traffic that is not correctly attributed due to the way that Netmon identifies traffic. We may be able to find some extra stuff there.<br />
Here’s a Catch-22, there may be traffic related to our application that Netmon wasn’t able to correlate back to the process but how can we identify it if we do not know the endpoints. We will be using Procmon to compile a more comprehensive endpoint collection later.</p>

<h5 id="how-to-search-in-netmon">4.1.1 How to search in Netmon?</h5>
<p><code>Contains</code> is a filter that allows us to do case-insensitive searchs for strings. For example we can use this filter to search for packets with destinations containing the string <code>sourceforge</code>. We can use the following filters (they both do the same thing):</p>

<ul>
  <li><code>Contains(property.Destination, "sourceforge")</code></li>
  <li><code>Destination.Contains("sourceforge")</code></li>
</ul>

<p>Be sure to select <code>All Traffic</code> in the tree-view when applying filters search in all traffic.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-23">
    <img src="/images/2015/TrafficAttribution1/03.PNG"
         width="986" height="390"
         alt="Click me."/>
  </a>
  <div id="image-dialog-23" style="display:none">
    <img src="/images/2015/TrafficAttribution1/03.PNG"
         width="1232" height="487"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-23").hide();
    jQuery("#image-dialog-23").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1272,
      minHeight: 527,
      title:     "Contains(property.Destination, ‘sourceforge’) ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-23").click(function() {
      jQuery("#image-dialog-23").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>We can search in different columns, one of the most common columns is <code>property.description</code>. Description is a column with a lot of information and is usually our best bet. For example if we want to see all GET request we can use the following filters (again they both do the same thing):</p>

<ul>
  <li><code>Contains(property.Description,"GET")</code></li>
  <li><code>Description.Contains("GET")</code></li>
</ul>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-24">
    <img src="/images/2015/TrafficAttribution1/04.PNG"
         width="1179" height="346"
         alt="Click me."/>
  </a>
  <div id="image-dialog-24" style="display:none">
    <img src="/images/2015/TrafficAttribution1/04.PNG"
         width="1474" height="432"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-24").hide();
    jQuery("#image-dialog-24").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1514,
      minHeight: 472,
      title:     "Contains(property.Description,’GET’) ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-24").click(function() {
      jQuery("#image-dialog-24").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>We can also see Windows checking for certificate revocation lists over HTTP <em>zomg</em>.</p>

<p>To search for binary data use <code>ContainsBin</code>. For example to search for the CRLF binary string in frame data use this filter:</p>

<ul>
  <li><code>ContainsBin(FrameData, HEX, "0D 0A")</code></li>
</ul>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-25">
    <img src="/images/2015/TrafficAttribution1/05.PNG"
         width="980" height="334"
         alt="Click me."/>
  </a>
  <div id="image-dialog-25" style="display:none">
    <img src="/images/2015/TrafficAttribution1/05.PNG"
         width="1225" height="418"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-25").hide();
    jQuery("#image-dialog-25").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1265,
      minHeight: 458,
      title:     "ContainsBin(FrameData, HEX, ‘0D 0A’) ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-25").click(function() {
      jQuery("#image-dialog-25").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>We can also search for strings using <code>ContainsBin</code> by using <code>ASCII</code>. But remember this search is case-sensitive. To replicate our previous search for <code>sourceforge</code> we can use the following filter:</p>

<ul>
  <li><code>ContainsBin(FrameData, ASCII, "sourceforge")</code></li>
</ul>

<h4 id="procmon">4.2 Procmon</h4>
<p>Procmon does not display traffic but it’s a great tool to identify enpoints. Stop the Procmon capture. It is time to add Procmon filters.</p>

<p>I am in the process of writing a longer blog entry about using Procmon but that is for another day. For now we will discuss some filters related to network endpoint discovery.</p>

<p>Procmon has a lot of filters but we will be using only a few of them. The first filter is <code>ProcessName</code>. Using this filter we can see only events belonging to specific process(es). Select Filter from the Filter menu or press Ctrl+L. Now create this filter <code>ProcessName is Notepad++.exe</code>. Note that Procmon will show you all processes with events in the drop down menu.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-26">
    <img src="/images/2015/TrafficAttribution1/06.PNG"
         width="426" height="368"
         alt="Click me."/>
  </a>
  <div id="image-dialog-26" style="display:none">
    <img src="/images/2015/TrafficAttribution1/06.PNG"
         width="532" height="460"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-26").hide();
    jQuery("#image-dialog-26").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  572,
      minHeight: 500,
      title:     "Creating a filter ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-26").click(function() {
      jQuery("#image-dialog-26").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>And we can see all events for <code>notepad++.exe</code> in Procmon. Take a note of ProcessID (PID) for <code>notepad++.exe</code>. In this case PID is <code>3964</code>.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-27">
    <img src="/images/2015/TrafficAttribution1/07.PNG"
         width="724" height="357"
         alt="Click me."/>
  </a>
  <div id="image-dialog-27" style="display:none">
    <img src="/images/2015/TrafficAttribution1/07.PNG"
         width="905" height="446"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-27").hide();
    jQuery("#image-dialog-27").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  945,
      minHeight: 486,
      title:     "ProcessName is notepad++.exe ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-27").click(function() {
      jQuery("#image-dialog-27").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>But we want to look at spawned processes too. Let’s remove this filter and find all child processes for <code>notepad++.exe</code> using another filter. The new filter is <code>Parent PID is 3964</code>and it will show captured events for <code>gup.exe</code>.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-28">
    <img src="/images/2015/TrafficAttribution1/08.PNG"
         width="747" height="437"
         alt="Click me."/>
  </a>
  <div id="image-dialog-28" style="display:none">
    <img src="/images/2015/TrafficAttribution1/08.PNG"
         width="934" height="546"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-28").hide();
    jQuery("#image-dialog-28").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  974,
      minHeight: 586,
      title:     "ProcessName is Parent PID is 3964 ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-28").click(function() {
      jQuery("#image-dialog-28").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>Doubleclick on the first line (<code>Process Start</code>) to view command line parameters and other details for <code>gup.exe</code>. Note that the <code>gup.exe</code> application was ran with parameter <code>-v6.792</code> (version of Notepad++). So theoretically we can pretend that we are any version. It would be nice to look at this request and play with it.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-29">
    <img src="/images/2015/TrafficAttribution1/09.PNG"
         width="508" height="609"
         alt="Click me."/>
  </a>
  <div id="image-dialog-29" style="display:none">
    <img src="/images/2015/TrafficAttribution1/09.PNG"
         width="635" height="761"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-29").hide();
    jQuery("#image-dialog-29").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  675,
      minHeight: 801,
      title:     "ProcessName is gup.exe and ProcessStart ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-29").click(function() {
      jQuery("#image-dialog-29").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>An alternate way to get the same results is to use these two filter:</p>

<ul>
  <li><code>ProcessName is notepad++.exe</code></li>
  <li><code>Operation is Process Create</code></li>
</ul>

<p>If we want to make sure that we have identified all processes, we have to go one level deeper and check if <code>gup.exe</code> spawned any other processes.</p>

<p>We have two options:</p>

<ol>
  <li><code>ProcessName is gup.exe</code> and <code>Operation is Process Create</code></li>
  <li><code>Parent PID is 3992</code> (pid of <code>gup.exe</code>)</li>
</ol>

<p>But as expected both filters return nothing. <code>gup.exe</code> did not spawn anything.</p>

<p>Now we can add both <code>notepad++.exe</code> and <code>gup.exe</code> as filters to view all events related to our application in Procmon.</p>

<p>In order to watch network traffic we can use the handy <code>Operation is TCP Send</code> filter. Note there are other operations (i.e. UDP ones). <code>TCP Connect</code> will also work if you just want endpoints and less noise.</p>

<p>We use the following filters:</p>

<ol>
  <li><code>ProcessName is notepad++.exe</code></li>
  <li><code>ProcessName is gup.exe</code></li>
  <li><code>Operation is TCP Send</code></li>
  <li><code>Operation is TCP Connect</code></li>
</ol>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-30">
    <img src="/images/2015/TrafficAttribution1/10.PNG"
         width="737" height="211"
         alt="Click me."/>
  </a>
  <div id="image-dialog-30" style="display:none">
    <img src="/images/2015/TrafficAttribution1/10.PNG"
         width="921" height="264"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-30").hide();
    jQuery("#image-dialog-30").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  961,
      minHeight: 304,
      title:     "Operation is TCP Connect and TCP Send ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-30").click(function() {
      jQuery("#image-dialog-30").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>We have already seen <code>downloads.sourceforge.net</code> but <code>ns378545.ip-91-121-64.eu</code> is new.</p>

<p>If we ping it, we can see that the corresponding IP address is <code>91.121.64.34</code>. We can filter the results in Netmon by using this filter <code>IPv4.Address == 91.121.64.34</code> to view traffic related to his IP address.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-31">
    <img src="/images/2015/TrafficAttribution1/11.PNG"
         width="918" height="341"
         alt="Click me."/>
  </a>
  <div id="image-dialog-31" style="display:none">
    <img src="/images/2015/TrafficAttribution1/11.PNG"
         width="1147" height="426"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-31").hide();
    jQuery("#image-dialog-31").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1187,
      minHeight: 466,
      title:     "IPv4.Address == 91.121.64.34 ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-31").click(function() {
      jQuery("#image-dialog-31").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>It is <code>notepad-plus-plus.org</code>. Try pinging <code>notepad-plus-plus.org</code> to get <code>91.121.64.34</code>.</p>

<p>That was easy wasn’t it?</p>

<p>What did we do? We used Netmon and Procmon to identify the endpoints that an specific application communicates with and isolate traffic belonging to that application. I told you this is nothing ground breaking :).</p>

<h3 id="questions">Questions:</h3>

<p><strong>But what about Microsoft Message Analyzer (MMA)?</strong></p>

<p>It is a good tool. But I do not like its UI but I saw an interesting feature in it to decrypt SSL traffic. I will be looking at that feature soon. It is also much more resource intensive than Netmon.</p>

<p>For more information: <a href="http://blogs.technet.com/b/messageanalyzer/archive/2015/06/08/process-tracking-with-message-analyzer.aspx">http://blogs.technet.com/b/messageanalyzer/archive/2015/06/08/process-tracking-with-message-analyzer.aspx</a></p>

<p><strong>But I want to use Wireshark</strong></p>

<p>Sure, go ahead. Use Procmon and filters to identify the endpoints and then add filters in Wireshark. Another good thing is that Netmon’s export format (*.cap files) can be opened in Wireshark. If you prefer Wireshark’s UI, you can isolate traffic by process in Netmon, save it and then open the resulting cap file in Wireshark.</p>

<p><strong>Where are DNS requests? I do not see them in process traffic in Netmon</strong></p>

<p>Select all traffic and use the filter <code>DNS</code>. Due to the way Netmon associates traffic with processes, DNS requests may be in Unknown or System.</p>

<p><div class='bogus-wrapper'><notextile><div class="imgpopup screen">
  <a href='javascript:void(0)' style="text-decoration: none" id="image-32">
    <img src="/images/2015/TrafficAttribution1/12.PNG"
         width="1031" height="310"
         alt="Click me."/>
  </a>
  <div id="image-dialog-32" style="display:none">
    <img src="/images/2015/TrafficAttribution1/12.PNG"
         width="1289" height="388"/>
    <br clear="all"/>
  </div>
</div>
<script type="text/javascript">
  jQuery(document).ready(function() {
    jQuery("#image-dialog-32").hide();
    jQuery("#image-dialog-32").dialog({
      autoOpen:  false,
      modal:     true,
      draggable: false,
      minWidth:  1329,
      minHeight: 428,
      title:     "DNS ",
      show:      'scale',
      hide:      'scale'
    });

    jQuery("#image-32").click(function() {
      jQuery("#image-dialog-32").dialog('open');
    });

  });
</script>
</notextile></div></p>

<p>Note that while we had a DNS query for <code>superb-dca2.dl.sourceforge.net</code>, we never connected to it so we did not see a <code>TCP Connect</code> event for it in Procmon.</p>

<h3 id="exercise">5. Exercise:</h3>
<p>Run the tools again and install a plugin. This can be accomplished by going to <code>Plugins &gt; Plugin Manager &gt; Show Plugin Manager</code>. Try to locate the endpoints and traffic in this case. See what process is spawned by <code>notepad++.exe</code> this time.</p>

<p>This time, it will not be as easy as last time because Netmon did not associate all packets with the process but you can find the endpoints via Procmon and filter them in Netmon.</p>

<p>I hope this was useful. If you have any questions, you know where to find me.</p>

<!-- links -->

]]></content>
  </entry>
  
</feed>
