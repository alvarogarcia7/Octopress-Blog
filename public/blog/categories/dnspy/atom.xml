<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: dnSpy | Parsia's Den]]></title>
  <link href="http://parsiya.net/blog/categories/dnspy/atom.xml" rel="self"/>
  <link href="http://parsiya.net/"/>
  <updated>2015-11-15T01:32:54-05:00</updated>
  <id>http://parsiya.net/</id>
  <author>
    <name><![CDATA[Parsiya]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Intro to .NET Remoting for Hackers]]></title>
    <link href="http://parsiya.net/blog/2015-11-14-intro-to-dot-net-remoting-for-hackers/"/>
    <updated>2015-11-14T16:22:36-05:00</updated>
    <id>http://parsiya.net/blog/intro-to-dot-net-remoting-for-hackers</id>
    <content type="html"><![CDATA[<p>This is a simple tutorial about <a href="https://msdn.microsoft.com/en-us/library/kwdt6w2k%28v=vs.71%29.aspx">.NET Remoting</a>. I am going to re-create a very simple RCE and local privilege escalation that I encountered in my projects and use it to explain .NET Remoting and simple debugging in <code>dnSpy</code>.</p>

<p>In this post we will:</p>

<ol>
  <li>Do a brief introduction to .NET Remoting</li>
  <li>Develop a simple .NET Remoting client and a vulnerable server in Visual Studio</li>
  <li>Observe .NET Remoting traffic</li>
  <li>See .NET Remoting in action by doing some basic debugging with dnSpy</li>
  <li>Re-create the vulnerable application</li>
  <li>Use dnSpy to patch and create modified .NET modules to exploit our sample vulnerable server</li>
</ol>

<p>If you know of any applications that use .NET Remoting please let me know. I want to look at them.</p>

<!--more-->

<h3 id="table-of-contents">Table of Contents:</h3>

<ul>
  <li><a href="#ch0">0. Ingredients and Setup</a></li>
  <li><a href="#ch1">1. Brief Intro to .NET Remoting</a></li>
  <li><a href="#ch2">2. Developing a .NET Remoting Application</a></li>
  <li><a href="#ch3">3. .NET Remoting Messages</a></li>
  <li><a href="#ch4">4. Debugging with dnSpy</a></li>
  <li><a href="#ch5">5. Re-creating the Vulnerability</a></li>
  <li><a href="#ch6">6. Modifying IL Instructions with dnSpy and Patching Binaries</a></li>
  <li><a href="#ch7">7. Remediation</a></li>
</ul>

<h3 id="a-namech0a-0-ingredients-and-setup"><a name="ch0"></a> 0. Ingredients and Setup</h3>

<ul>
  <li>Windows 7 Virtual Machine</li>
  <li>Visual Studio Community 2015: <a href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx">https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx</a>. We only need the C# components which are part of the default installation</li>
  <li>RawCap to capture local traffic</li>
  <li>Wireshark to analyze captured traffic</li>
  <li><a href="https://github.com/0xd4d/dnSpy/releases/tag/v1.4.0.0">dnSpy (1.4.0.0)</a> to decompile and debug C# code</li>
</ul>

<h3 id="a-namech1a-1-brief-intro-to-net-remoting"><a name="ch1"></a> 1. Brief Intro to .NET Remoting</h3>
<p>In simple words, .NET Remoting is a means to achieve InterProcess Communication (IPC). One application (let’s call it server) exposes some remotable objects. Other applications (we will call them clients) create an instance of those objects and treat them like local objects. But these local objects will be executed on the server. Usually these remotable objects are in a shared library (e.g. DLL). Both client and server will have a copy of this DLL. .NET Remoting can use TCP, HTTP or named pipes to transfer the remotable objects.</p>

<p>The concept of .NET Remoting is very similar to <a href="http://www.oracle.com/technetwork/java/javase/tech/index-jsp-138781.html">Java Remote Method Invocation (Java RMI)</a>. In Java RMI we will see serialized Java objects being passed around and in .NET Remoting we will see .NET objects.</p>

<p>Don’t worry if you do not understand parts of it because this was a very short intro. We will see how .NET Remoting works later.</p>

<p><strong>Note</strong>: .NET Remoting is deprecated and you should not be using it. But who am I kidding? We are all using old technology all the time so we might as well get used to it.</p>

<h3 id="a-namech2a-2-developing-a-net-remoting-application"><a name="ch2"></a> 2. Developing a .NET Remoting Application</h3>
<p>I am going to create two version of my simple .NET Remoting applications. Both are very simple. The first application will act as tutorial about how to create a .NET Remoting client/server application and the second aims to re-create a vulnerable server that I encountered in one of my projects.</p>

<p>I am going to be using <a href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx">Visual Studio Community 2015</a> which is free. We will have three different projects in one solution.</p>

<ul>
  <li>Remoting Library: A DLL which contains the remotable objects.</li>
  <li>Server</li>
  <li>Client</li>
</ul>

<p>If you want to play along, Visual Studio solutions are at <a href="https://bitbucket.org/parsiya/net-remoting/src/.">https://bitbucket.org/parsiya/net-remoting/src/</a>. With compiled executables being in the <code>Executables</code> directory (keep in mind that these are executables from a stranger on the internet so treat them accordingly).</p>

<p>First the DLL. Create a solution and a new project. Choose <code>Class Library</code> as type of the project. According to <a href="https://msdn.microsoft.com/en-us/library/vstudio/h8f0y3fc%28v=vs.100%29.aspx">this MSDN article</a>, in order for an object to be remotable it should either be <code>Serializable</code> or inherit <a href="https://msdn.microsoft.com/en-us/library/system.marshalbyrefobject%28v=vs.110%29.aspx"><code>MarshalByRefObject</code></a> class. I am take the <code>MarshalByRefObject</code> route. For more information please refer to <a href="https://msdn.microsoft.com/library/wcf3swha%28v=vs.100%29.aspx">Making Objects Remotable</a>.</p>

<p>Here’s how the Remoting Library (the DLL) looks like:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>RemotingLibrary.cs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">namespace</span> <span class="nn">RemotingSample</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">RemoteMath</span> <span class="p">:</span> <span class="n">MarshalByRefObject</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// add</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">“</span><span class="n">Add</span><span class="p">({</span><span class="m">0</span><span class="p">},{</span><span class="m">1</span><span class="p">})</span> <span class="n">called</span><span class="err">”</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="k">public</span> <span class="kt">int</span> <span class="n">Sub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// subtract</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Sub({0},{1}) called&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">a</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>   <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</code></pre>

<p>Note that the class <code>RemoteMath</code> is derived from <code>MarshalByRefObject</code> to make it remotable. We don’t need to do anything else with regards to .NET Remoting in this DLL. Each function will print some text when it is called so we can see where the function actually runs.</p>

<p>Create a new project named <code>Server</code> and use the following code. The comments should explain what is happening:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Server.cs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting.Channels</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting.Channels.Tcp</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">namespace</span> <span class="nn">RemotingSample</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Server</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// create a TCP channel and bind it to port 8888</span>
</span><span class='line'>      <span class="n">TcpChannel</span> <span class="n">remotingChannel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TcpChannel</span><span class="p">(</span><span class="m">8888</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span>  <span class="c1">// register the channel, the second parameter is ensureSecurity</span>
</span><span class='line'>  <span class="c1">// I have set it to false to disable encryption and signing</span>
</span><span class='line'>  <span class="c1">// for more information see section Remarks in https://msdn.microsoft.com/en-us/library/ms223155(v=vs.90).aspx</span>
</span><span class='line'>  <span class="n">ChannelServices</span><span class="p">.</span><span class="n">RegisterChannel</span><span class="p">(</span><span class="n">remotingChannel</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// create a new servicetype of type RemoteMath named &quot;rMath&quot; and of type SingleCall</span>
</span><span class='line'>  <span class="c1">// SingleCall: a new object will be created for each call</span>
</span><span class='line'>  <span class="c1">// as opposed to WellKnownObjectMode.Singleton where there is one object for all calls (and clients)</span>
</span><span class='line'>  <span class="n">WellKnownServiceTypeEntry</span> <span class="n">remoteObject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WellKnownServiceTypeEntry</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RemoteMath</span><span class="p">),</span> <span class="s">&quot;rMath&quot;</span><span class="p">,</span> <span class="n">WellKnownObjectMode</span><span class="p">.</span><span class="n">SingleCall</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// register the remoteObject servicetype</span>
</span><span class='line'>  <span class="n">RemotingConfiguration</span><span class="p">.</span><span class="n">RegisterWellKnownServiceType</span><span class="p">(</span><span class="n">remoteObject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Registered service&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Press any key to exit&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>   <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</code></pre>

<p>We need to add two references to the project using <code>Project (menu) &gt; Add References</code>:</p>

<ol>
  <li><code>System.Runtime.Remoting</code> assembly</li>
  <li>Remoting Library project</li>
</ol>

<p>Server will expose the <code>RemoteMath</code> class and wait until a key is pressed. Client can call the functions in <code>RemoteMath</code> until the server is terminated.</p>

<p>Client code also needs the same two references. Client calls <code>Add</code> and <code>Sub</code> and prints the results.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Client.cs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting.Channels</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.Remoting.Channels.Tcp</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">namespace</span> <span class="nn">RemotingSample</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Client</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// create and register the TCP channel</span>
</span><span class='line'>      <span class="c1">// please note that I have set the security of the channel to false</span>
</span><span class='line'>      <span class="n">TcpChannel</span> <span class="n">clientRemotingChannel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TcpChannel</span><span class="p">();</span>
</span><span class='line'>      <span class="n">ChannelServices</span><span class="p">.</span><span class="n">RegisterChannel</span><span class="p">(</span><span class="n">clientRemotingChannel</span><span class="p">,</span> <span class="k">false</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span>  <span class="c1">// create an object of type RemothMath</span>
</span><span class='line'>  <span class="c1">// we have to do a cast because Activator.GetObject returns an object (doh)</span>
</span><span class='line'>  <span class="c1">// type is RemoteMath and server address is what we created in Server.cs (port:8888 and rMath)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Server.cs code:</span>
</span><span class='line'>  <span class="c1">// TcpChannel remotingChannel = new TcpChannel(8888);</span>
</span><span class='line'>  <span class="c1">// ChannelServices.RegisterChannel(remotingChannel, false);</span>
</span><span class='line'>  <span class="c1">// WellKnownServiceTypeEntry remoteObject = new WellKnownServiceTypeEntry(typeof(RemoteMath), &quot;rMath&quot;, WellKnownObjectMode.SingleCall);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">RemoteMath</span> <span class="n">remoteMathObject</span> <span class="p">=</span> <span class="p">(</span><span class="n">RemoteMath</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">GetObject</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RemoteMath</span><span class="p">),</span> <span class="s">&quot;tcp://localhost:8888/rMath&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// now we can call Add and Sub functions</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Result of Add(1, 2): {0}&quot;</span><span class="p">,</span> <span class="n">remoteMathObject</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Result of Sub(10, 3): {0}&quot;</span><span class="p">,</span> <span class="n">remoteMathObject</span><span class="p">.</span><span class="n">Sub</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Press any key to exit&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>   <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</code></pre>

<p>Now we can build the solution. If you look at the resulting executables we will that both client and server have a copy of <code>RemotingLibrary.dll</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/01.png' width='' height='' title='Both Client and Server have the same DLL'><span class='caption-text'>Both Client and Server have the same DLL</span></span></p>

<p>Now start <code>RawCap</code> and capture local traffic.</p>

<h3 id="a-namech3a-3-net-remoting-messages"><a name="ch3"></a> 3. .NET Remoting Messages</h3>

<p>When you initially run the server, it will ask to be added to Windows Firewall’s exceptions. You can safely deny that as both client and server are local. This is a major vulnerability in many .NET Remoting applications that work locally (like our example). If we do a <code>netstat</code> we can see that server is bound to <code>0.0.0.0</code> and is listening on all interfaces. Meaning anyone can connect to the server and execute exposed functions on our computer. We will read more about this later.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/02.png' width='' height='' title='Server listening on all interfaces'><span class='caption-text'>Server listening on all interfaces</span></span></p>

<p>Now run both server and client and look at the results.</p>

<p>We can see client calling both functions and printing the result.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/03.png' width='' height='' title='Client execution'><span class='caption-text'>Client execution</span></span></p>

<p>We can clearly see that the functions were executed in server’s application context because server is printing the verbose messages from <code>RemotingLibrary.dll</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/04.png' width='' height='' title='Server execution'><span class='caption-text'>Server execution</span></span></p>

<p>If we look at the traffic in Wireshark and filter all traffic to/from port <code>8888</code>:</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/05.png' width='' height='' title='.NET Remoting traffic in Wireshark'><span class='caption-text'>.NET Remoting traffic in Wireshark</span></span></p>

<p>You can read about the format and structure of .NET Remoting packets in the following documents:</p>

<ul>
  <li><a href="http://download.microsoft.com/download/9/5/E/95EF66AF-9026-4BB0-A41D-A4F81802D92C/%5BMS-NRTP%5D.pdf">[MS-NRTP].NET Core Protocol - PDF</a> or just search for <code>[MS-NRTP]</code>.</li>
  <li><a href="http://download.microsoft.com/download/9/5/E/95EF66AF-9026-4BB0-A41D-A4F81802D92C/%5BMS-NRBF%5D.pdf">[MS-NRBF] .NET Remoting: Binary Format Data Structure - PDF</a> or just search for <code>[MS-NRBF]</code>.</li>
</ul>

<p>After the TCP handshake we see the first packet from client to server. According to section <code>2.2.3.3 Message Frame Structure</code> of <code>[MS-NRTP]</code> every message should start with <code>ProtocolId</code> which is 4 bytes and should be <code>0x54454E2E</code> or <code>.NET</code>.</p>

<pre><code>2e 4e 45 54 01 00 00 00 00 00 8d 00 00 00 04 00  .NET............
01 01 1a 00 00 00 74 63 70 3a 2f 2f 6c 6f 63 61  ......tcp://loca
6c 68 6f 73 74 3a 38 38 38 38 2f 72 4d 61 74 68  lhost:8888/rMath
06 00 01 01 18 00 00 00 61 70 70 6c 69 63 61 74  ........applicat
69 6f 6e 2f 6f 63 74 65 74 2d 73 74 72 65 61 6d  ion/octet-stream
00 00                                            ..

.NET tcp://localhost:8888/rMath application/octet-stream

ProtocolId: 0x54454E2E or .NET
Major version: 0x00
Minor Version: 0x00
OperationType: 0x0000 or Request
</code></pre>

<p>This is setting up the .NET Remoting channel and specifying the exposed class that it wants to access <code>rMath</code>. Next is the second part of the first message.</p>

<pre><code>00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00  ................
00 15 12 00 00 00 12 03 41 64 64 12 61 52 65 6d  ........Add.aRem
6f 74 69 6e 67 53 61 6d 70 6c 65 2e 52 65 6d 6f  otingSample.Remo
74 65 4d 61 74 68 2c 20 52 65 6d 6f 74 69 6e 67  teMath, Remoting
4c 69 62 72 61 72 79 2c 20 56 65 72 73 69 6f 6e  Library, Version
3d 31 2e 30 2e 30 2e 30 2c 20 43 75 6c 74 75 72  =1.0.0.0, Cultur
65 3d 6e 65 75 74 72 61 6c 2c 20 50 75 62 6c 69  e=neutral, Publi
63 4b 65 79 54 6f 6b 65 6e 3d 6e 75 6c 6c 02 00  cKeyToken=null..
00 00 08 01 00 00 00 08 02 00 00 00 0b           .............

Add RemotingSample.RemoteMath, RemotingLibrary, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
</code></pre>

<p>This is the <code>Add(1,2)</code> call. We can see the following in this message:</p>

<pre><code>RemotingLibrary: DLL containing the exposed class
RemotingSample.Remotemath: The exposed class
Add: The function that is called
</code></pre>

<p>And if you look closely you can see the <code>Add</code> parameters in the last line in little endian (Int32 or 4 bytes).</p>

<pre><code>01 00 00 00: int a
02 00 00 00: int b
</code></pre>

<p>I don’t want to talk about the message structure, just identifying the method, parameters, class and DLL when we see such a packet is enough.</p>

<p>For a very good explanation of all fields using examples please refer to section <code>4.1 Two-Way Method Invocation Using TCP-Binary</code> of <code>[MS-NRTP]</code>.</p>

<p>Think of the reply as an ACK and like any other .NET Remoting message it starts with <code>.NET</code>. According to <code>[MS-NRTP] Section 2.1.1.1.2 Receiving Reply</code> “If the OperationType of the message is Request(0), an implementation MUST wait for the Two-Way Reply message in the same connection.”</p>

<pre><code>2e 4e 45 54 01 00 02 00 00 00 1c 00 00 00 00 00 .NET............

ProtocolId: 0x54454E2E or .NET
Major version: 0x00
Minor Version: 0x00
OperationType: 0x0002 or Response
</code></pre>

<p>Then the actual result is sent from server to client.</p>

<pre><code>00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00  ................
00 16 11 08 00 00 08 03 00 00 00 0b              ............
</code></pre>

<p>We can see the return value (which is again an Int32 and 4 bytes) at the end of the packet prefixed by the same <code>0x08</code> byte that we saw before (remember the parameters?), and is <code>03 00 00 00</code>.</p>

<p>Messages for <code>Sub</code> are very similar. I am not going to talk about them because, ahem <code>they are left as an exercise for the reader</code>.</p>

<h3 id="a-namech4a-4-debugging-with-dnspy"><a name="ch4"></a> 4. Debugging with dnSpy</h3>

<p>In this section, I assume you know basic debugging (e.g. breakpoints, step into/over/out) so I will not go into details. I will mostly just talk about (some of) dnSpy’s features.</p>

<p>Run <code>Server.exe</code> and then run dnSpy (for x86 application use <code>dnSpy-x86.exe</code>). Drag and drop <code>Client.exe</code> into it and navigate to <code>Main</code>. Notice that dnSpy automatically loads referenced DLLs including <code>RemotingLibrary.dll</code>. The decompiled code in dnSpy is the same as our original code but without the comments.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/06.png' width='' height='' title='Opening Client.exe in dnSpy'><span class='caption-text'>Opening Client.exe in dnSpy</span></span></p>

<p>Now we can run the client in dnSpy. Click on the green button named <code>Start</code> and it will open a dialog to start an executable in dnSpy. In version 1.4 it is pre-populated with <code>Client.exe</code> that we just dragged and dropped into dnSpy. As you can see, what can also specify arugments and also order the debugger to break on certain events. Let’s keep the original selection and run <code>Client.exe</code>. dnSpy will break on <code>Main</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/07.png' width='' height='' title='Start options'><span class='caption-text'>Start options</span></span></p>

<p>Now we can debug normally using shortcut keys or small button to the right of the <code>Continue</code> button (formerly <code>Start</code>).</p>

<p>To set a breakpoint, you can either select a line and press <code>F2</code>, click on the space left of the line number or right click on the line and select it from the context menu. In this case we put a breakpoint on line <code>16</code> or the first <code>Console.WriteLine</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/08.png' width='' height='' title='Breakpoint'><span class='caption-text'>Breakpoint</span></span></p>

<h4 id="finding-nemo">4.1 Finding Nemo</h4>
<p>In this case, we can clearly see the <code>Add</code> function and where it is called. But let’s assume that we only saw the traffic and opened the binary in dnSpy and didn’t know where it is called. Our binary contains tons and tons of imaginary functions that may or may not call <code>Add</code>. How do we find <code>Add</code>?</p>

<p>From the traffic we know that the function name is <code>Add</code> and it is in class <code>RemotingSample.Remotemath</code> and resides in <code>RemotingLibrary.dll</code>. Using these clues we can easily find the <code>Add</code> function in dnSpy.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/09.png' width='' height='' title='Finding Add'><span class='caption-text'>Finding Add</span></span></p>

<p>Our first instinct would be to put a breakpoint on <code>Add</code> and let the client <code>Continue</code>. But <strong>this breakpoint will never trigger</strong>. Because in .NET Remoting an instance of the function is created on the client and then executed on the server. If you don’t believe me, try it. But how do we find who uses this function?</p>

<h4 id="analyze-this">4.2 Analyze This</h4>
<p>Now we can use the <code>Analyze</code> feature of dnSpy. Right click on the <code>Add</code> function in <code>RemotingLibrary.dll</code> and select <code>Analyze</code>. Now a very handy new pane (window? seriously what are these called?) named <code>Analyzer</code> pops up. We can see the function and two items <code>Uses</code> and <code>Used By</code>. <code>Uses</code> shows us the other functions (in loaded binaries in dnSpy) that are used by <code>Add</code> and <code>Used By</code> shows other functions that use <code>Add</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/10.png' width='' height='' title='Analyze this'><span class='caption-text'>Analyze this</span></span></p>

<p>That is a very nifty feature, neh? As you can see we can go down the wormhole and follow the chain. In this case we see that the <code>Main</code> function calls <code>Add</code>. If we double click on <code>Main</code> we will go back to the original entry point.</p>

<h4 id="net-remoting-in-action">4.3 .NET Remoting in Action</h4>
<p>Now we can <code>Step Into</code> the line that calls <code>Add</code> in the client. If you have not changed the default settings, you should land in <code>mscorlib.dll</code> or more exactly in <code>CommonLanguageRuntimeLibrary.System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke()</code>. dnSpy’s default settings, will skip all the other code (like attribute get/set etc). You can change this in <code>View (menu) &gt; Options (menu item) &gt; Debugger (tab) &gt; DebuggerBrowsable</code> and <code>Call string-conversion</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/11.png' width='' height='' title='Landed in RealProxy'><span class='caption-text'>Landed in RealProxy</span></span></p>

<p>In order to see local variables and their values press <code>Alt+4</code> to open the <code>Locals</code> window. This was changed in version 1.3 and up and is a huge UX upgrade.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/12.png' width='' height='' title='Meeting the Locals'><span class='caption-text'>Meeting the Locals</span></span></p>

<p>This where we always end up after following .NET Remoting calls; where the message is being sent and we can see its contents. In version 1.3 of dnSpy, any breakpoints set here would not be triggered but now we can do it (what a time to be alive). So you can set a breakpoint on line 404 (if you can find it <em>he he he</em>) <code>RemotingProxy remotingProxy = null;</code> just right before <code>if (1 == type)</code> and look at messages.</p>

<p><code>Type == 1</code> so the first <code>if</code> will be true. Let’s look at it (with some comments):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="m">1</span> <span class="p">==</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Message</span> <span class="n">expr_14</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Message</span><span class="p">();&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// msgData is one of the function parameters (along with type) and contains the message info</span>
</span><span class='line'>  <span class="c1">// we can see that it is used to populate expr&lt;em&gt;14 which looks like a temp Message</span>
</span><span class='line'>  <span class="n">expr</span><span class="p">&lt;/</span><span class="n">em</span><span class="p">&gt;</span><span class="m">14.</span><span class="n">InitFields</span><span class="p">(</span><span class="n">msgData</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// expr&lt;em&gt;14 is copied to message</span>
</span><span class='line'>  <span class="n">message</span> <span class="p">=</span> <span class="n">expr</span><span class="p">&lt;/</span><span class="n">em</span><span class="p">&gt;</span><span class="m">14</span><span class="p">;</span>			<span class="c1">// put a breakpoint here&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">num</span> <span class="p">=</span> <span class="n">expr_14</span><span class="p">.</span><span class="n">GetCallType</span><span class="p">();</span>
</span><span class='line'><span class="p">}&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Let’s put a breakpoint on line <code>409 num = message = expr_14;</code> and continue. When we reach this line, we can step over it until we reach line <code>410</code> and then see the contents of the variable named <code>message</code>. Why didn’t we put a breakpoint on the next line? Because if it won’t trigger with default settings (remember those debugger settings at the start of this section?). Press <code>Alt+4</code> to look at <code>message</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/13.png' width='' height='' title='Contents of variable message'><span class='caption-text'>Contents of variable message</span></span></p>

<p>We can see the message and a lot of information about it. Scroll down to line <code>474 RealProxy.HandleReturnMessage(message, message2);</code> and set a breakpoint on line <code>475</code> and <code>Continue</code>. We can see that the text in the function is printed on the server and we land in the new breakpoint and can see the return value in <code>message2</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/14.png' width='' height='' title='Return value'><span class='caption-text'>Return value</span></span></p>

<p>If we <code>Step Out</code> we will land back in <code>Main</code>. Try doing the same for the <code>Sub</code> function call.</p>

<p>Now we know the places to see the outgoing .NET Remoting message and return values. In a real world project we could do this to look at the messages instead of Wireshark or developing our own .NET Remoting proxy.</p>

<h3 id="a-namech5a-5-re-creating-the-vulnerability"><a name="ch5"></a> 5. Re-creating the Vulnerability</h3>

<p><strong>Note:</strong> Please run this application in a Virtual Machine disconnected from the internet. This application will make your machine vulnerable to unauthenticated RCE. Make sure that Windows firewall is not disabled and do not allow <code>Server.exe</code> through it. I believe the chance of someone getting compromised is very very slim because no one reads these posts anyway, but it never hurts to be careful.</p>

<p>One application that I looked at, let’s call it <code>Remoting Expanded</code> had two components. A server which was run as <code>SYSTEM</code> on startup via a Windows service and a client application which was executed by an standard user. Client used .NET Remoting to execute functions in server to perform actions that were not available to standard users. I basically went through the same steps to look at and debug the .NET Remoting calls. I was looking at the decompiled code of the DLL containing the remotable objects and discovered that there are a lot of exposed functions which are not used by the client application. One of them was <code>StartProcess</code> (that’s not its real name) and executed an executable as SYSTEM.</p>

<p>To re-create we are going to change our code and add a new function to the <code>RemotingLibrary</code> DLL. Client and server are not modified but be sure to rebuild the solution to get the new DLL in build directories of client and server projects. I created a new project and called it <code>RemotingLibraryExpanded</code>.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>RemotingLibraryExpanded.cs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">namespace</span> <span class="nn">RemotingLibraryExpanded</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">RemoteMathExpanded</span> <span class="p">:</span> <span class="n">MarshalByRefObject</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// add</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">“</span><span class="n">Add</span><span class="p">({</span><span class="m">0</span><span class="p">},{</span><span class="m">1</span><span class="p">})</span> <span class="n">called</span><span class="err">”</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="k">public</span> <span class="kt">int</span> <span class="n">Sub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// subtract</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Sub({0},{1}) called&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">a</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// super secret process start method</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">StartProcess</span><span class="p">(</span><span class="kt">string</span> <span class="n">processPath</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Starting process {0}&quot;</span><span class="p">,</span> <span class="n">processPath</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">processPath</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>   <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">code</span><span class="p">&gt;&lt;/</span><span class="n">pre</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now we can rebuild the solution. Client and server will run as before now we want to exploit this new method to do local privilege escalation (running the executable of our choice as SYSTEM). At this point we can either write code (which we already did) or modify the client application using dnSpy (and some other tools). I modified the application in my project because it was much easier than writing code from scratch because there were a lot of stuff happening before the client started making calls to server.</p>

<h3 id="a-namech6a-6-modifying-il-instructions-with-dnspy-and-patching-binaries"><a name="ch6"></a> 6. Modifying IL Instructions with dnSpy and Patching Binaries</h3>
<p>The easiest thing to do is to modify one of the function calls to call <code>StartProcess</code> and run an executable (e.g. <code>C:\Windows\System32\calc.exe</code>). Open the client in dnSpy and right click on the line that calls <code>Add</code> (line 16 in dnSpy). Choose <code>Edit IL Instructions</code>.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/15.png' width='' height='' title='IL instructions'><span class='caption-text'>IL instructions</span></span></p>

<p>What is IL? CIL (Common Intermediate Language) or IL is (almost) the .NET equivalent of Java bytecode. Let’s look at what we got and see if we can decipher it (read the comments please):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>IL code for line 16 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// pop remoteMathObject from stack and put it in local variable 1</span>
</span><span class='line'><span class="m">12</span>	<span class="m">0028</span>	<span class="n">stloc</span><span class="p">.</span><span class="m">1</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// push the string to stack</span>
</span><span class='line'><span class="m">13</span>	<span class="m">0029</span>	<span class="n">ldstr</span>	<span class="err">“</span><span class="n">Result</span> <span class="n">of</span> <span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">):</span> <span class="p">{</span><span class="m">0</span><span class="p">}</span><span class="err">”</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// push local variable 1 to stack. In this case, remoteMathObject is pushed to stack</span>
</span><span class='line'><span class="c1">// this is done because we are going to call remoteMathObject.Add</span>
</span><span class='line'><span class="m">14</span>	<span class="m">002</span><span class="n">E</span>	<span class="n">ldloc</span><span class="p">.</span><span class="m">1</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// push the value 0x1 to the stack</span>
</span><span class='line'><span class="c1">// IL has ldc.i4.1 to ldc.i4.8 and also a separate ldc.i4 &lt;int32&gt; to push Ints to the stack</span>
</span><span class='line'><span class="m">15</span>	<span class="m">002F</span>	<span class="n">ldc</span><span class="p">.</span><span class="n">i4</span><span class="p">.</span><span class="m">1</span><span class="p">&lt;/</span><span class="n">int32</span><span class="p">&gt;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// push the value 0x2 to the stack</span>
</span><span class='line'><span class="m">16</span>	<span class="m">0030</span>	<span class="n">ldc</span><span class="p">.</span><span class="n">i4</span><span class="p">.</span><span class="m">2</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// call Add</span>
</span><span class='line'><span class="m">17</span>	<span class="m">0031</span>	<span class="n">callvirt</span>	<span class="n">instance</span> <span class="n">int32</span> <span class="p">[</span><span class="n">RemotingLibrary</span><span class="p">]</span><span class="n">RemotingSample</span><span class="p">.</span><span class="n">RemoteMath</span><span class="p">::</span><span class="n">Add</span><span class="p">(</span><span class="n">int32</span><span class="p">,</span> <span class="n">int32</span><span class="p">)&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// box converts a value type to an object reference.</span>
</span><span class='line'><span class="c1">// I assume it means that we are converting the result of add to Int32</span>
</span><span class='line'><span class="m">18</span>	<span class="m">0036</span>	<span class="n">box</span>	<span class="p">[</span><span class="n">mscorlib</span><span class="p">]</span><span class="n">System</span><span class="p">.</span><span class="n">Int32</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// call console.writeline (parameters are the format string that was pushed to stack and return value of add)</span>
</span><span class='line'><span class="m">19</span>	<span class="m">003</span><span class="n">B</span>	<span class="n">call</span>	<span class="k">void</span> <span class="p">[</span><span class="n">mscorlib</span><span class="p">]</span><span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">::</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">)&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now we have a general idea of what’s happening here. We need to change <code>Add</code> to <code>StartProcess</code>. Click on <code>Add</code> and a small context menu pops up.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/16.png' width='' height='' title='Method context menu'><span class='caption-text'>Method context menu</span></span></p>

<p>Select <code>Method</code> and a new page pops up that allows you to modify it to any method in all loaded assemblies. We can see the new fancy <code>StartProcess</code> function. So we select that. There’s also a handy search feature.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/17.png' width='' height='' title='Pick a method'><span class='caption-text'>Pick a method</span></span></p>

<p>The method call is changed but <code>Add</code> had two Int32 parameters while <code>StartProcess</code> has only one string parameter. Without more modifications, two Int32s are pushed to the stack before the new method is being called. If we press OK on the IL code window we will see this monstrosity.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/18.png' width='' height='' title='You ruined everything!!1!'><span class='caption-text'>You ruined everything!!1!</span></span></p>

<p>But that’s fine, we can edit the IL instructions and fix it. But how do we know what to do? At this point we can just learn IL coding but based on the instructions that we have seen, we should have a general idea of what to do. We also need to remove the <code>Console.WriteLine</code> becaue <code>StartProcess</code> has no return value (well <code>void()</code> but you know what I mean) and we should be calling <code>remoteMathObject.StartProcess("c:\\windows\\system32\\calc.exe");</code> individually.</p>

<p>The following IL code does the trick:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Fixed IL instructions </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="m">12</span>	<span class="m">0028</span>	<span class="n">stloc</span><span class="p">.</span><span class="m">1</span>
</span><span class='line'><span class="m">13</span>	<span class="m">0029</span>	<span class="n">ldloc</span><span class="p">.</span><span class="m">1</span>
</span><span class='line'><span class="m">14</span>	<span class="m">002</span><span class="n">A</span>	<span class="n">ldstr</span>	<span class="err">“</span><span class="n">c</span><span class="p">:</span><span class="err">\</span><span class="n">windows</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">calc</span><span class="p">.</span><span class="n">exe</span><span class="err">”</span>
</span><span class='line'><span class="m">15</span>	<span class="m">002F</span>	<span class="n">callvirt</span>	<span class="n">instance</span> <span class="k">void</span> <span class="p">[</span><span class="n">RemotingLibraryExpanded</span><span class="p">]</span><span class="n">RemotingLibraryExpanded</span><span class="p">.</span><span class="n">RemoteMathExpanded</span><span class="p">::</span><span class="n">StartProcess</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
</span><span class='line'><span class="m">16</span>	<span class="m">0034</span>	<span class="n">nop</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/19.png' width='' height='' title='You fixed it!!1!'><span class='caption-text'>You fixed it!!1!</span></span></p>

<p>There is another way to do this. Download <a href="https://www.linqpad.net/Download.aspx">LINQPad 5.0</a>. The standard version is free and is more than enough for our purpose. Copy paste all of the code in the client class into it. Now just like in Visual Studio we need to add references and import namespaces.</p>

<ol>
  <li>Change the <code>Language</code> drop-down list to <code>C# Program</code>.</li>
  <li>Right click and select <code>References and Properties</code>.</li>
  <li>In the <code>References</code> tab click <code>Add</code> and search for <code>System.Runtime.Remoting.dll</code>.</li>
  <li>Click <code>Browse</code> and select <code>RemotingLibraryExpanded.dll</code>.</li>
  <li>Select the <code>Additional Namespace Imports</code> tab.</li>
  <li>Click <code>Pick from assemblies</code>.</li>
  <li>Select <code>RemotingLibraryExpanded.dll</code> and add its namespace.</li>
  <li>Select <code>System.Runtime.Remoting.dll</code> and add <code>System.Runtime.Remoting.Channels</code> and <code>System.Runtime.Remoting.Channels.Tcp</code>.</li>
</ol>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/20.png' width='' height='' title='References in LINQPad'><span class='caption-text'>References in LINQPad</span></span></p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/21.png' width='' height='' title='Namespaces in LINQPad'><span class='caption-text'>Namespaces in LINQPad</span></span></p>

<p>Now all of the errors in LINQPad should be gone and we can modify the code. Modify the first <code>Console.WriteLine</code> to <code>StartProcess("c:\\windows\system32\calc.exe")</code> and press <code>Execute</code>. The application may or may not execute properly. It will probably fail because we already have a TCP channel registered but we don’t care about that. Click on the <code>IL</code> button at the bottom to see the generated IL code which is the same as what we wrote in dnSpy.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/22.png' width='' height='' title='IL code in LINQPad'><span class='caption-text'>IL code in LINQPad</span></span></p>

<p>Now we can save the modified module (in this case a new version of the client executable) using dnSpy. Use <code>File (menu) &gt; Save Module</code> to save the new executable (let’s call it <code>Client1.exe</code>). Run <code>Client1.exe</code> and Pew.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/23.png' width='' height='' title='Pew Pew'><span class='caption-text'>Pew Pew</span></span></p>

<p><em>How can this be used in local privilege escalation?</em><br />
In the original project, server was running as SYSTEM, which means any standard user could run any binary or command and effectively give themselves admin.</p>

<p><em>How does this lead to Remote Code Execution (RCE)?</em><br />
As we saw at the start of this post, server is listening on <code>0.0.0.0</code> or all interfaces. This means any attacker can connect to the server and execute arbitrary commands. Windows Firewall will not help if you had added an exception for server when it was initially started.</p>

<h3 id="a-namech7a-7-remediation"><a name="ch7"></a> 7. Remediation</h3>
<p>Remediation is an important part of my day job. I am not an <code>infosec thoughtleader</code> but I think breaking is worth nothing if we don’t want to/cannot talk to and work with the developers to fix things. So I am going to add remediation sections to my posts where appropriate and do my small part in helping. As with any other part of these posts, if you think there is a better way of doing things please let me know.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/24.jpg' width='' height='' title='[insert reference to Starship Troopers and killing bugs and call yourself a geek]'><span class='caption-text'>[insert reference to Starship Troopers and killing bugs and call yourself a geek]</span></span></p>

<p>It should be noted that channel properties and registration could also be done in executables’ config files. Please refer to <a href="https://msdn.microsoft.com/en-us/library/ms973907.aspx">Format for .NET Remoting Configuration Files</a> for more information.</p>

<p>I also have to reiterate that <strong>this is decprecated technology</strong> and it should not be used for new applications. But if you are stuck with legacy code and want to fix it, please read on.</p>

<p>Start here for MSDN articles on this topic: <a href="https://msdn.microsoft.com/en-us/library/9hwst9th%28v=vs.85%29.aspx">Security in Remoting</a>.</p>

<h4 id="rce">7.1 RCE</h4>
<p>In this scenario we should only be listening on <code>localhost</code>. We have to modify the server. If we look at <a href="https://msdn.microsoft.com/library/bb397830%28v=vs.100%29.aspx">TcpChannel properties</a> we can see there is a <code>bindTo</code> property. We can add it to a dictionary and use it in the constructor as follows:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Binding the server to localhost </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">IDictionary</span> <span class="n">tcpChannelProperties</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span><span class='line'><span class="n">tcpChannelProperties</span><span class="p">[</span><span class="err">“</span><span class="n">port</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="m">8888</span><span class="p">;</span>
</span><span class='line'><span class="n">tcpChannelProperties</span><span class="p">[</span><span class="err">“</span><span class="n">bindTo</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="err">“</span><span class="m">127.0</span><span class="p">.</span><span class="m">0.1</span><span class="err">”</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">TcpChannel</span> <span class="n">remotingChannel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TcpChannel</span><span class="p">(</span><span class="n">tcpChannelProperties</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// Or in the config file:&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">channel</span> <span class="k">ref</span><span class="p">=</span><span class="s">&quot;tcp&quot;</span> <span class="n">port</span><span class="p">=</span><span class="s">&quot;8888&quot;</span> <span class="n">bindto</span><span class="p">=</span><span class="s">&quot;127.0.0.1&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And now we can see the server listening only on localhost.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/25.png' width='' height='' title='Pew Pew'><span class='caption-text'>Pew Pew</span></span></p>

<p>We can also <a href="https://msdn.microsoft.com/en-us/library/bb187429%28v=vs.85%29.aspx">authenticate the client</a>.</p>

<h4 id="channel-encryption-and-authentication">7.2 Channel Encryption and Authentication</h4>
<p>We can also encrypt the channel. Channels have a <code>Secure</code> property that will encrypt the channel if set to <code>true</code>. However, <strong>both client and server channels should be set to secure</strong>. We can simply add it to <code>tcpChannelProperties</code> in both client and server and set it to <code>true</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Securing the server channel </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">IDictionary</span> <span class="n">tcpChannelProperties</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span><span class='line'><span class="n">properttcpChannelPropertiesies</span><span class="p">[</span><span class="err">“</span><span class="n">port</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="m">8888</span><span class="p">;</span>
</span><span class='line'><span class="n">tcpChannelProperties</span><span class="p">[</span><span class="err">“</span><span class="n">bindTo</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="err">“</span><span class="m">127.0</span><span class="p">.</span><span class="m">0.1</span><span class="err">”</span><span class="p">;</span>
</span><span class='line'><span class="n">tcpChannelProperties</span><span class="p">[</span><span class="err">“</span><span class="n">secure</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">TcpChannel</span> <span class="n">remotingChannel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TcpChannel</span><span class="p">(</span><span class="n">tcpChannelProperties</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// Or in the config file:&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>	<span class="p">&lt;</span><span class="n">channel</span> <span class="k">ref</span><span class="p">=</span><span class="s">&quot;tcp&quot;</span> <span class="n">port</span><span class="p">=</span><span class="s">&quot;8888&quot;</span> <span class="n">bindto</span><span class="p">=</span><span class="s">&quot;127.0.0.1&quot;</span> <span class="n">secure</span><span class="p">=</span><span class="s">&quot;true&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Let’s only set the server channel to secure and see what happens:</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/26.png' width='' height='' title='Unsecure client channel and secure server channel'><span class='caption-text'>Unsecure client channel and secure server channel</span></span></p>

<p>The client establishes the TCP connection and starts sending message in plaintext, but server never responds.</p>

<p>If we modify the client code similar to the server:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Securing the client channel </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">IDictionary</span> <span class="n">tcpChannelProperties</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span><span class='line'><span class="n">tcpChannelProperties</span><span class="p">[</span><span class="err">“</span><span class="n">secure</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="c1">// Or in the config file:&lt;/p&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>	<span class="p">&lt;</span><span class="n">channel</span> <span class="k">ref</span><span class="p">=</span><span class="s">&quot;tcp&quot;</span> <span class="n">secure</span><span class="p">=</span><span class="s">&quot;true&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">channels</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now the channel is encrypted.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/2015/remoting1/27.png' width='' height='' title='Encrypted TCP channel'><span class='caption-text'>Encrypted TCP channel</span></span></p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/k62k71x0%28v=vs.85%29.aspx">Encryption and Message Integrity</a> MSDN article talks about encryption. The <code>See Also</code> links at the bottom of the page go to authentication articles. For example <a href="https://msdn.microsoft.com/en-us/library/59hafwyt%28v=vs.85%29.aspx">Authentication with the TCP Channel</a>.</p>

<hr />

<p>Hopefully this was useful. This will pave the way for another blog post where I talk about an older vulnerability that we will investigate using dnSpy and .NET Remoting. If you have any comments/feedback/corrections/complaints, please let me know; you know where to find me.</p>

<!-- links -->
]]></content>
  </entry>
  
</feed>
